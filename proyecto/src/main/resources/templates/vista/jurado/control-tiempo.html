<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Coordinador</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .container-custom {
            max-width: 600px;
            margin: 0 auto;
        }

        .header-box {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .categoria-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .lista-participantes {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .lista-participantes h5 {
            color: #333;
            margin-bottom: 1rem;
        }

        .participante-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .participante-card:not(.bloqueado):hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .participante-card.bloqueado {
            opacity: 0.5;
            cursor: not-allowed;
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
        }

        .participante-card.activo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
        }

        .participante-nombre {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }

        .participante-info {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .participante-estado {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
        }

        /* Modal de cron√≥metro */
        .modal-timer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-timer.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-content {
            background: white;
            border-radius: 30px;
            padding: 2rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .timer-participante {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 2rem;
            font-weight: bold;
        }

        .timer-display {
            font-size: 5rem;
            font-weight: bold;
            margin: 2rem 0;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        .timer-display.verde { color: #4caf50; }
        .timer-display.amarillo { color: #ff9800; }
        .timer-display.rojo { 
            color: #f44336;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }

        .timer-mensaje {
            font-size: 1.1rem;
            margin: 1rem 0;
            font-weight: 500;
        }

        .btn-finalizar {
            background: #f44336;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            display: none;
        }

        .swal2-container {
        z-index: 10000 !important;
    }

        .btn-finalizar:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }

        /* Modal de confirmaci√≥n */
        .modal-confirm {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-confirm.active {
            display: flex;
        }

        .confirm-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 90%;
            width: 350px;
            text-align: center;
        }

        .confirm-content h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        .confirm-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-confirm {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-confirm.si {
            background: #4caf50;
            color: white;
        }

        .btn-confirm.no {
            background: #f44336;
            color: white;
        }

        .btn-confirm:hover {
            transform: scale(1.05);
        }

        /* Notificaci√≥n */
        .sync-notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 0.5rem;
            z-index: 9998;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .sync-notification.active {
            display: flex;
        }

        .sync-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Estado vac√≠o */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #999;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Loader */
        .loader {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @media (max-width: 480px) {
            .timer-display {
                font-size: 3.5rem;
            }
        }

        #uiLockOverlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.35);
        z-index: 9998;
        display: none;
        }
    </style>
</head>
<body>
    <div class="container-custom">
        <!-- Header -->
        <div class="header-box">
            <h1 class="header-title">
                <i class="fas fa-clipboard-check"></i> Panel de Control
            </h1>
            <div style="margin-top: 1rem;">
                <small style="color: #666;">
                    Coordinador: <strong th:text="${usuario.persona.nombreCompleto}">Admin</strong>
                </small>
                <br>
                <span class="categoria-badge">
                    <i class="fas fa-calendar"></i> 
                    <span th:text="${actividad.nombre}">Concurso de Baile</span>
                </span>
            </div>
        </div>

        <!-- Lista de participantes -->
        <div class="lista-participantes">
            <h5>
                <i class="fas fa-users"></i> Participantes Inscritos
            </h5>
            <div id="listaParticipantes">
                <div class="loader">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem; color: #666;">Cargando participantes...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Cron√≥metro -->
    <div class="modal-timer" id="modalTimer">
        <div class="timer-content">
            <div class="timer-participante" id="timerParticipante">-</div>
            <div class="timer-display verde" id="timerDisplay">15:00</div>
            <div class="timer-mensaje" id="timerMensaje">Tiempo de presentaci√≥n</div>
            <button class="btn-finalizar" id="btnFinalizar">
                <i class="fas fa-stop"></i> Finalizar presentaci√≥n
            </button>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div class="modal-confirm" id="modalConfirm">
        <div class="confirm-content">
            <h3><i class="fas fa-question-circle"></i> Confirmar inicio</h3>
            <p id="confirmMensaje">¬øIniciar cron√≥metro?</p>
            <div class="confirm-buttons">
                <button class="btn-confirm no" onclick="cancelarInicio()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirm si" onclick="confirmarInicio()">
                    <i class="fas fa-check"></i> Iniciar
                </button>
            </div>
        </div>
    </div>

    <!-- Overlay que bloquea la UI cuando hay cron√≥metro activo -->
    <div id="uiLockOverlay" style="display:none;"></div>

    <!-- Sonido para aviso final -->
    <audio id="audioAlerta" preload="auto">
        <source src="/assets/audio/010607649_prev.mp3" type="audio/mpeg">
        <!-- Puedes cambiar el src por una ruta v√°lida en tu proyecto -->
    </audio>


    <!-- Notificaci√≥n -->
    <div class="sync-notification" id="syncNotification">
        <i class="fas fa-sync sync-icon"></i>
        <span>Sincronizando con jurados...</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="javascript">

        let wakeLock = null;
        // Estado global
        const STATE = {
            participantes: [],
            timerInterval: null,
            tiempoRestante: 900, // 15 minutos
            participanteActivo: null,
            pendienteConfirmacion: null
        };

        const idActividad = 2;

        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        $(document).ready(() => {
            cargarParticipantes();
            recuperarEstadoCronometro();
        });

        // ‚≠ê RECUPERAR CRON√ìMETRO ACTIVO AL CARGAR
        function recuperarEstadoCronometro() {
            $.ajax({
                url: '/coordinador/cronometro/estado/' + idActividad,
                method: 'GET',
                dataType: 'json',
                success: function(estadoServidor) {
                    if (estadoServidor && estadoServidor.activo) {
                        console.log('üîÑ Recuperando cron√≥metro activo:', estadoServidor);
                        
                        // Calcular tiempo restante basado en servidor
                        const tiempoTranscurrido = Math.floor((Date.now() - estadoServidor.inicioTimestamp) / 1000);
                        const tiempoRestante = Math.max(0, 900 - tiempoTranscurrido);
                        
                        if (tiempoRestante > 0) {
                            // Recrear estado
                            STATE.participanteActivo = estadoServidor.participante;
                            STATE.inicioTimestamp = estadoServidor.inicioTimestamp;
                            STATE.tiempoRestante = tiempoRestante;
                            
                            // Reactivar cron√≥metro visualmente
                            reanudarCronometro(STATE.participanteActivo, tiempoRestante);
                        } else {
                            // Ya expir√≥, finalizar
                            finalizarCronometroSinParticipante(estadoServidor.participante);
                        }
                    }
                },
                error: function(xhr) {
                    console.log('No hay cron√≥metro activo o error al recuperar');
                }
            });
        }

        // ‚≠ê REANUDAR CRON√ìMETRO EXISTENTE
        function reanudarCronometro(participante, tiempoRestante) {
            STATE.participanteActivo = participante;
            STATE.tiempoRestante = tiempoRestante;
            
            // Mostrar modal
            $('#timerParticipante').text(participante.nombre);
            $('#modalTimer').addClass('active');
            $('#btnFinalizar').show();
            
            lockUI();
            solicitarWakeLock();
            
            // Actualizar vista inmediatamente
            actualizarDisplay();
            
            // Continuar conteo
            let notifyCounter = 0;
            STATE.timerInterval = setInterval(() => {
                // Calcular desde timestamp original
                const tiempoTranscurrido = Math.floor((Date.now() - STATE.inicioTimestamp) / 1000);
                STATE.tiempoRestante = Math.max(0, 900 - tiempoTranscurrido);
                
                notifyCounter++;

                const estado = STATE.tiempoRestante > 180 ? 'verde' :
                            STATE.tiempoRestante > 0 ? 'amarillo' : 'rojo';

                actualizarDisplay();

                if (notifyCounter % 2 === 0 || STATE.tiempoRestante <= 5) {
                    notificarServidor({
                        accion: 'actualizar',
                        participanteId: participante.id,
                        participanteNombre: participante.nombre,
                        timestamp: Date.now(),
                        tiempoRestante: STATE.tiempoRestante,
                        estado: estado
                    });
                }

                if (STATE.tiempoRestante === 180) {
                    if (navigator.vibrate) navigator.vibrate([100,50,100]);
                }

                if (STATE.tiempoRestante <= 0) {
                    finalizarCronometro(false);
                }
            }, 1000);
        }

        // ========================================
        // CARGAR PARTICIPANTES DESDE EL SERVIDOR
        // ========================================
        function cargarParticipantes() {
            $.ajax({
                url: '/coordinador/participantes/' + idActividad,
                method: 'GET',
                dataType: 'json',
                success: function(participantes) {
                    console.log('‚úÖ Participantes cargados:', participantes);
                    
                    if (!participantes || participantes.length === 0) {
                        mostrarEstadoVacio();
                        return;
                    }
                    
                    // Agregar estado "pendiente" por defecto
                    STATE.participantes = participantes.map(p => ({
                        ...p,
                        estado: p.estado || 'pendiente'
                    }));
                    
                    renderParticipantes();
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error cargando participantes:', error);
                    mostrarError('Error al cargar participantes. Por favor, recarga la p√°gina.');
                }
            });
        }

        // ========================================
        // RENDERIZAR LISTA DE PARTICIPANTES
        // ========================================
        function renderParticipantes() {
            const container = $('#listaParticipantes');
            container.empty();

            STATE.participantes.forEach(p => {
                const esActivo = p.estado === 'activo';
                const esBloqueado = p.estado === 'completado';
                
                const clases = ['participante-card'];
                if (esBloqueado) clases.push('bloqueado');
                if (esActivo) clases.push('activo');
                
                const icono = esBloqueado ? '‚úÖ' : esActivo ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';

                const $card = $('<div>')
                    .addClass(clases.join(' '))
                    .html(`
                        <div class="participante-nombre">${p.nombre}</div>
                        <div class="participante-info">
                            <i class="fas fa-school"></i> ${p.institucion || 'Sin instituci√≥n'}
                        </div>
                        <div class="participante-estado">${icono}</div>
                    `);

                // Solo permitir click si est√° pendiente
                if (p.estado === 'pendiente') {
                    $card.on('click', () => mostrarConfirmacion(p));
                }

                container.append($card);
            });
        }

        function mostrarEstadoVacio() {
            $('#listaParticipantes').html(`
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <div>No hay participantes inscritos en esta actividad</div>
                </div>
            `);
        }

        function mostrarError(mensaje) {
            $('#listaParticipantes').html(`
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle" style="color: #f44336;"></i>
                    <div style="color: #f44336;">${mensaje}</div>
                    <button onclick="cargarParticipantes()" 
                            style="margin-top: 1rem; padding: 0.5rem 1rem; border: none; 
                                   background: #667eea; color: white; border-radius: 10px; cursor: pointer;">
                        <i class="fas fa-refresh"></i> Reintentar
                    </button>
                </div>
            `);
        }

        // ========================================
        // MODAL DE CONFIRMACI√ìN
        // ========================================
        function mostrarConfirmacion(participante) {
            STATE.pendienteConfirmacion = participante;
            $('#confirmMensaje').html(`¬øIniciar cron√≥metro para <strong>${participante.nombre}</strong>?`);
            $('#modalConfirm').addClass('active');
        }

        function cancelarInicio() {
            STATE.pendienteConfirmacion = null;
            $('#modalConfirm').removeClass('active');
        }

        function confirmarInicio() {
            const participante = STATE.pendienteConfirmacion;
            $('#modalConfirm').removeClass('active');
            
            iniciarCronometro(participante);
        }

        // ========================================
        // CRON√ìMETRO
        // ========================================
        function iniciarCronometro(participante) {
            STATE.participanteActivo = participante;
            STATE.tiempoRestante = 900; // Reset a 15 minutos

            STATE.inicioTimestamp = Date.now();
            
            // Actualizar estado local
            participante.estado = 'activo';
            renderParticipantes();

            // Mostrar modal de timer
            $('#timerParticipante').text(participante.nombre);
            $('#modalTimer').addClass('active');
            
            // Vibraci√≥n inicial
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }

            // Bloquear UI (evita que otras acciones se ejecuten)
            lockUI();
            // mostrar bot√≥n finalizar y asegurarnos visible
            $('#btnFinalizar').show();

            solicitarWakeLock();

            // Notificar al servidor (INICIAR)
            notificarServidor({
                accion: 'iniciar',
                participanteId: participante.id,
                participanteNombre: participante.nombre,
                timestamp: STATE.inicioTimestamp,
                tiempoRestante: STATE.tiempoRestante,
                estado: 'verde'
            });

            // enviar cada 2s (mejor performance)
            let notifyCounter = 0;
            STATE.timerInterval = setInterval(() => {
                
                const tiempoTranscurrido = Math.floor((Date.now() - STATE.inicioTimestamp) / 1000);
                STATE.tiempoRestante = Math.max(0, 900 - tiempoTranscurrido);

                notifyCounter++;

                const estado = STATE.tiempoRestante > 180 ? 'verde' :
                            STATE.tiempoRestante > 0 ? 'amarillo' : 'rojo';

                // Actualizar display local cada segundo (para UX)
                actualizarDisplay();

                // Notificar solo cada 2 segundos (reduce tr√°fico a la mitad)
                if (notifyCounter % 2 === 0 || STATE.tiempoRestante <= 5) {
                    notificarServidor({
                        accion: 'actualizar',
                        participanteId: participante.id,
                        participanteNombre: participante.nombre,
                        timestamp: Date.now(),
                        tiempoRestante: STATE.tiempoRestante,
                        estado: estado
                    });
                }

                if (STATE.tiempoRestante === 180) {
                    if (navigator.vibrate) navigator.vibrate([100,50,100]);
                }

                if (STATE.tiempoRestante <= 0) {
                    finalizarCronometro(false);
                }
            }, 1000);
        }

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('üì± App visible de nuevo - verificando estado...');
                
                // Verificar si hay cron√≥metro activo en servidor
                if (!STATE.participanteActivo) {
                    recuperarEstadoCronometro();
                } else {
                    // Ya tenemos uno activo, solo resincronizar tiempo
                    const tiempoTranscurrido = Math.floor((Date.now() - STATE.inicioTimestamp) / 1000);
                    STATE.tiempoRestante = Math.max(0, 900 - tiempoTranscurrido);
                    actualizarDisplay();
                    solicitarWakeLock();
                }
            }
        });

        // Funci√≥n para mantener pantalla activa
        async function solicitarWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('‚úÖ Wake Lock activado - pantalla permanecer√° encendida');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock liberado');
                    });
                }
            } catch (err) {
                console.warn('No se pudo activar Wake Lock:', err);
            }
        }

        // Liberar Wake Lock al finalizar
        function closeTimerModalAndReset() {
            if (STATE.timerInterval) {
                clearInterval(STATE.timerInterval);
                STATE.timerInterval = null;
            }

            // ‚≠ê LIBERAR WAKE LOCK
            if (wakeLock !== null) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                    console.log('Wake Lock liberado manualmente');
                });
            }

            $('#modalTimer').removeClass('active');
            $('#btnFinalizar').hide();
            unlockUI();

            STATE.participanteActivo = null;
            STATE.tiempoRestante = 900;
            $('#timerDisplay').text('15:00').removeClass('amarillo rojo').addClass('verde');
            $('#timerMensaje').text('Tiempo de presentaci√≥n');

            renderParticipantes();
        }

        function actualizarDisplay() {
            const minutos = Math.floor(STATE.tiempoRestante / 60);
            const segundos = STATE.tiempoRestante % 60;
            const display = `${minutos}:${segundos.toString().padStart(2, '0')}`;
            
            const $display = $('#timerDisplay');
            const $mensaje = $('#timerMensaje');
            const $btnFinalizar = $('#btnFinalizar');

            $display.text(display);

            // Cambiar colores y mensajes
            if (STATE.tiempoRestante > 180) {
                $display.removeClass().addClass('timer-display verde');
                $mensaje.text('Tiempo de presentaci√≥n');
            } else if (STATE.tiempoRestante > 0) {
                $display.removeClass().addClass('timer-display amarillo');
                $mensaje.text('‚ö†Ô∏è ¬°√öltimos 3 minutos!');
            } else {
                $display.removeClass().addClass('timer-display rojo');
                $mensaje.text('‚è∞ ¬°Tiempo finalizado!');

                if (navigator.vibrate) {
                    navigator.vibrate([500, 200, 500]);
                }
            }

        }

        // ---- Helpers UI lock ----
        function lockUI() {
            $('.participante-card').css('pointer-events', 'none').css('opacity', 0.6);
        }

        function unlockUI() {
            $('#uiLockOverlay').hide();
            $('.participante-card').css('pointer-events', '').css('opacity', '');
        }

        // ======= Funci√≥n que limpia y cierra modal de forma segura =======
        function closeTimerModalAndReset() {
            // detener interval si existe
            if (STATE.timerInterval) {
                clearInterval(STATE.timerInterval);
                STATE.timerInterval = null;
            }

            // ocultar modal y botones
            $('#modalTimer').removeClass('active');
            $('#btnFinalizar').hide();

            // desbloquear UI
            unlockUI();

            // limpiar estado
            STATE.participanteActivo = null;
            STATE.tiempoRestante = 900;
            // opcional: reset display (visual)
            $('#timerDisplay').text('15:00').removeClass('amarillo rojo').addClass('verde');
            $('#timerMensaje').text('Tiempo de presentaci√≥n');

            // refrescar lista y estado visual
            renderParticipantes();
        }

        // ======= Confirmaci√≥n segura con fallback (Swal opcional) =======
        function solicitarFinalizarPorUsuario() {
            // Si SweetAlert2 disponible, usarla
            console.log("he llegado a antes de solicitar")
                Swal.fire({
                    title: 'Finalizar presentaci√≥n',
                    html: `<strong>${STATE.participanteActivo ? STATE.participanteActivo.nombre : ''}</strong><br>
                        ¬øDeseas finalizar la presentaci√≥n ahora?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, finalizar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#d33'
                }).then(result => {
                    if (result.isConfirmed) {
                        finalizarCronometro(true);
                    }
                }).catch(err => {
                    // fallback: si Swal falla por cualquier motivo, finalizar directamente
                    console.warn('Swal fallo o cancelado:', err);
                    finalizarCronometro(true);
                });
        }

        // Cambiar binding: en lugar de direct onclick al btnFinalizar, usar este binding seguro
        $(document).on('click', '#btnFinalizar', function(e) {
            e.preventDefault();
            console.log("he hehco click en finalizar")
            if (!STATE.participanteActivo) return;
            solicitarFinalizarPorUsuario();
        });

        // ======= finalizarCronometro robusta =======
        function finalizarCronometro(porUsuario = false) {
            // Parar timers inmediatamente
            if (STATE.timerInterval) {
                clearInterval(STATE.timerInterval);
                STATE.timerInterval = null;
            }

            // Si no hay participante activo y no viene porUsuario, no hacemos nada
            if (!STATE.participanteActivo && !porUsuario) {
                // Asegurar estado consistente
                closeTimerModalAndReset();
                return;
            }

            // Marcar estado completado localmente (si existe participante)
            if (STATE.participanteActivo) {
                STATE.participanteActivo.estado = 'completado';
            }

            // Notificamos al servidor (intenta, pero no bloquea la UI)
            try {
                notificarServidor({
                    accion: 'finalizar',
                    participanteId: STATE.participanteActivo ? STATE.participanteActivo.id : null,
                    participanteNombre: STATE.participanteActivo ? STATE.participanteActivo.nombre : null,
                    timestamp: Date.now()
                });
            } catch(e) {
                console.warn('Error notificando finalizaci√≥n:', e);
            }

            // Mostrar mensaje y efectos (sonido / vibraci√≥n)
            $('#timerMensaje').text('‚è∞ ¬°Tiempo finalizado!');
            $('#timerDisplay').removeClass('verde amarillo').addClass('rojo');
            $('#btnFinalizar').hide();

            try {
                const audio = document.getElementById('audioAlerta');
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(()=>{});
                }
            } catch (e) {}

            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);

            if (porUsuario) {
                // Si usuario hizo la acci√≥n: cerrar y resetear tras un breve delay
                setTimeout(() => {
                    closeTimerModalAndReset();
                }, 800);
            } else {
                // Si expir√≥ por tiempo: mostrar confirm reversible y luego cerrar
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Tiempo finalizado',
                        html: `El tiempo de <strong>${STATE.participanteActivo ? STATE.participanteActivo.nombre : ''}</strong> termin√≥.`,
                        icon: 'info',
                        confirmButtonText: 'Cerrar y marcar como completado'
                    }).then(() => {
                        closeTimerModalAndReset();
                    }).catch(() => {
                        // fallback: cerrar de todas formas
                        closeTimerModalAndReset();
                    });
                } else {
                    // fallback simple
                    alert('El tiempo ha finalizado');
                    closeTimerModalAndReset();
                }
            }
        }

        // ========================================
        // NOTIFICAR AL SERVIDOR (SSE)
        // ========================================
        function notificarServidor(data) {
            mostrarSync();
            
            $.ajax({
                url: '/jurado/cronometro/actualizar',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    console.log('‚úÖ Notificaci√≥n enviada:', response);
                },
                error: function(xhr) {
                    console.error('‚ùå Error notificando:', xhr);
                },
                complete: function() {
                    setTimeout(ocultarSync, 800);
                }
            });
        }

        function mostrarSync() {
            $('#syncNotification').addClass('active');
        }

        function ocultarSync() {
            $('#syncNotification').removeClass('active');
        }

        // ========================================
        // PREVENIR CIERRE ACCIDENTAL
        // ========================================
        window.addEventListener('beforeunload', (e) => {
            if (STATE.participanteActivo) {
                e.preventDefault();
                e.returnValue = 'Hay un cron√≥metro activo. ¬øEst√°s seguro de salir?';
            }
        });
    </script>
</body>
</html>