<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n de Danzas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        /* CRON√ìMETRO FLOTANTE */
        .cronometro-flotante {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: white;
            border-radius: 20px;
            padding: 1rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 9999;
            min-width: 200px;
            text-align: center;
            display: none;
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .cronometro-flotante.activo {
            display: block;
        }

        .cronometro-participante {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .cronometro-tiempo {
            font-size: 2.5rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin: 0.5rem 0;
            transition: all 0.3s ease;
        }

        .cronometro-tiempo.verde { color: #4caf50; }
        .cronometro-tiempo.amarillo { color: #ff9800; }
        .cronometro-tiempo.rojo { 
            color: #f44336;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }

        .cronometro-estado {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 10px;
            display: inline-block;
        }

        .cronometro-estado.verde {
            background: #e8f5e9;
            color: #4caf50;
        }

        .cronometro-estado.amarillo {
            background: #fff3e0;
            color: #ff9800;
        }

        .cronometro-estado.rojo {
            background: #ffebee;
            color: #f44336;
        }

       

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           NAVBAR
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        .navbar-jurado {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 0;
            margin-bottom: 20px;
        }

        .navbar-brand {
            font-weight: bold;
            color: #667eea !important;
            font-size: 1.3rem;
        }

        .navbar-brand i {
            color: #764ba2;
            margin-right: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin: 0;
        }

        .user-role {
            font-size: 12px;
            color: #666;
            margin: 0;
        }

        .btn-logout {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
            color: white;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           CONTENEDOR PRINCIPAL
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        .container-custom {
            max-width: 900px;
            margin: 0 auto;
        }
        .header-box {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        .header-title {
            color: #667eea;
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }
        .categoria-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            margin-top: 10px;
            font-weight: 600;
        }
        .lista-participantes {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .participante-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .participante-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        .participante-item.evaluado {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .participante-nombre {
            font-weight: 600;
            color: #333;
        }
        .badge-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-evaluado {
            background: #28a745;
            color: white;
        }
        .badge-pendiente {
            background: #ffc107;
            color: #333;
        }
        .resumen-box {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .progress-custom {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar-custom {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 0.5s;
        }
        /* Modal */
        .modal-evaluacion {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            overflow-y: auto;
        }
        .modal-evaluacion.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content-custom {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header-custom {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
        }
        .modal-body-custom {
            padding: 25px;
        }
        .criterio-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .criterio-nombre {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        .input-puntaje {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }
        .total-box {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
        .total-puntos {
            font-size: 32px;
            font-weight: bold;
        }
        .btn-custom {
            padding: 12px 30px;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-guardar {
            background: #28a745;
            color: white;
            flex: 1;
        }
        .btn-guardar:hover {
            background: #218838;
        }
        .btn-cerrar {
            background: #6c757d;
            color: white;
            flex: 1;
        }
        .btn-cerrar:hover {
            background: #5a6268;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
        }
        /* Participante bloqueado */
        .participante-item.bloqueado {
            background: #f8f9fa !important;
            border-left: 4px solid #28a745;
            cursor: not-allowed !important;
        }

        .participante-item.bloqueado:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* Mensaje de completado */
        #mensajeCompleto {
            animation: slideIn 0.5s ease-out;
            border-left: 5px solid #28a745;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal header con estado */
        .modal-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #estadoEvaluacion {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-jurado">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#">
                <i class="fas fa-clipboard-check"></i>
                Panel de Evaluaci√≥n
            </a>
            
            <div class="user-info">
                <!-- Avatar con iniciales -->
                <div class="user-avatar" th:text="${jurado.persona.nombres != null ? jurado.persona.nombres.substring(0,1) : 'J'}">
                    J
                </div>
                
                <!-- Informaci√≥n del usuario -->
                <div class="user-details">
                    <p class="user-name" th:text="${jurado.persona.nombreCompleto}">Juan P√©rez</p>
                    <p class="user-role">
                        <i class="fas fa-user-shield"></i> Jurado - 
                        <span th:text="${nombreCategoria}">Categor√≠a</span>
                    </p>
                </div>
                
                <!-- Bot√≥n cerrar sesi√≥n -->
                <a href="/cerrar_sesionAdm" id="btnCerrarSesion" class="btn btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </a>
            </div>
        </div>
    </nav>
    <!-- CRON√ìMETRO FLOTANTE -->
    <div class="cronometro-flotante" id="cronometroFlotante">
        <div class="cronometro-participante" id="cronometroParticipante">
            <i class="fas fa-user"></i> -
        </div>
        <div class="cronometro-tiempo verde" id="cronometroTiempo">15:00</div>
        <div class="cronometro-estado verde" id="cronometroEstado">
            <i class="fas fa-play-circle"></i> En curso
        </div>
    </div>
    <div class="container-custom">
        <div class="header-box">
            <h1 class="header-title">
                <i class="fas fa-clipboard-check"></i> Panel de Evaluaci√≥n
            </h1>
            <div class="mt-3">
                <small class="text-muted">
                    Jurado: <strong th:text="${jurado.persona.nombreCompleto}">Juan P√©rez</strong>
                </small>
                <br>
                <span class="categoria-badge">
                    <i class="fas fa-tag"></i> <span th:text="${nombreCategoria}">Categor√≠a A</span>
                </span>
            </div>
        </div>
        <div class="lista-participantes">
            <h5 class="mb-3">
                <i class="fas fa-users"></i> Participantes a evaluar:
            </h5>
            <div id="listaParticipantes"></div>
        </div>
        <div class="resumen-box">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <strong>Progreso:</strong>
                    <span id="textoProgreso">0 de 0 evaluados</span>
                </div>
                <span id="estadoGeneral" class="badge bg-secondary">
                    <i class="fas fa-hourglass-half"></i> En progreso
                </span>
            </div>
            <div class="progress-custom">
                <div class="progress-bar-custom" id="barraProgreso" style="width: 0%">0%</div>
            </div>
        </div>
        <div id="mensajeCompleto" class="alert alert-success" style="display: none;">
            <i class="fas fa-check-circle"></i>
            <strong>¬°Evaluaciones completadas!</strong>
            <p class="mb-0">Has evaluado a todos los participantes. Las evaluaciones han sido guardadas autom√°ticamente.</p>
        </div>
    </div>

    <div class="modal-evaluacion" id="modalEvaluacion">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h3 style="margin: 0;">
                    <i class="fas fa-edit"></i> <span id="nombreParticipanteModal">-</span>
                </h3>
                <span id="estadoEvaluacion" class="badge badge-status" style="display: none;"></span>
            </div>
            <div class="modal-body-custom">
                <!-- Dentro de modal-body-custom, antes de #criteriosContainer -->
                <div id="modalCronometro" style="display:none; margin-bottom: 1rem;">
                    <div class="modal-cronometro">
                        <div class="modal-cronometro-participante" id="modalCronometroParticipante"><i class="fas fa-user"></i> -</div>
                        <div class="modal-cronometro-tiempo verde" id="modalCronometroTiempo">15:00</div>
                        <div class="modal-cronometro-estado verde" id="modalCronometroEstado"><i class="fas fa-play-circle"></i> En curso</div>
                    </div>
                </div>

                <div id="criteriosContainer"></div>
                
                <div class="total-box">
                    <div class="total-label">TOTAL</div>
                    <div class="total-puntos">
                        <span id="totalPuntos">0</span> / <span id="totalMax">50</span>
                    </div>
                </div>
                
                <div class="d-flex" style="gap: 10px;">
                    <button class="btn-custom btn-cerrar" onclick="cerrarModal()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                    <button class="btn-custom btn-guardar" onclick="guardarEvaluacion()">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="javascript">
        let faseActual = 'recorrido';
        let eventSource = null;   // <- usar let, no const
        let participanteEnPresentacion = null;

        let participanteSeleccionado = null;
        let datosCompletos = {};
        const idActividad = /*[[${idActividad}]]*/ null;

        document.addEventListener('DOMContentLoaded', () => {
            const btnCerrarSesion = document.getElementById('btnCerrarSesion');
            
            if (btnCerrarSesion) {
                btnCerrarSesion.addEventListener('click', async (e) => {
                    e.preventDefault(); 
                    
                    const urlCerrarSesion = btnCerrarSesion.href;

                    const cerrarSesion = () => {
                        window.location.href = urlCerrarSesion;
                    };

                    if (datosCompletos && datosCompletos.participantes) {
                        const total = datosCompletos.participantes.length;
                        const evaluados = datosCompletos.participantes.filter(p => p.evaluado).length;
                        const hayPendientes = total > evaluados;

                        let resultado;

                        if (hayPendientes) {
                            resultado = await Swal.fire({
                                title: '‚ö†Ô∏è Advertencia',
                                html: `Tienes **${total - evaluados}** evaluaciones pendientes.<br><br>Si cierras sesi√≥n ahora, podr√°s continuar despu√©s, pero las evaluaciones pendientes seguir√°n sin completarse.`,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'S√≠, cerrar sesi√≥n',
                                cancelButtonText: 'Cancelar',
                                confirmButtonColor: '#d33'
                            });

                        } else {
                            resultado = await Swal.fire({
                                title: '‚úÖ ¬°Evaluaciones completadas!',
                                text: 'Has completado todas tus evaluaciones. ¬øDeseas cerrar sesi√≥n?',
                                icon: 'success',
                                showCancelButton: true,
                                confirmButtonText: 'S√≠, cerrar sesi√≥n',
                                cancelButtonText: 'Cancelar'
                            });
                        }
                        
                        if (resultado.isConfirmed) {
                            cerrarSesion();
                        }
                        
                    } else {
                        const resultado = await Swal.fire({
                            title: '¬øCerrar Sesi√≥n?',
                            text: '¬øEst√°s seguro de que deseas cerrar sesi√≥n?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: 'S√≠, cerrar sesi√≥n',
                            cancelButtonText: 'Cancelar'
                        });

                        if (resultado.isConfirmed) {
                            cerrarSesion();
                        }
                    }
                });
            }
        });

        $(document).ready(function() {cargarDatos(); console.log("Document ready -> iniciarSSE()"); iniciarSSE();});

        function cargarDatos() {
            $.ajax({
                url: '/jurado/datos/' + idActividad,
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (!response.success) {
                        alert('‚ùå Error: ' + (response.message || 'Error desconocido'));
                        return;
                    }
                    
                    datosCompletos = response.categoria;
                    renderizarParticipantes();
                    actualizarProgreso();
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error al cargar datos:', error);
                    console.error('Response:', xhr.responseText);
                    alert('‚ùå Error al cargar los datos de evaluaci√≥n. Por favor, recarga la p√°gina.');
                }
            });
        }

        function renderizarParticipantes() {
            const container = $('#listaParticipantes');
            
            if (!datosCompletos || !datosCompletos.participantes || datosCompletos.participantes.length === 0) {
                container.html(`
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <div>No hay participantes para evaluar</div>
                    </div>
                `);
                return;
            }
            
            let html = '';
            datosCompletos.participantes.forEach(function(p) {
                const claseItem = p.evaluado ? 'evaluado bloqueado' : '';
                const cursor = p.evaluado ? 'cursor: not-allowed; opacity: 0.7;' : 'cursor: pointer;';
                
                html += `
                    <div class="participante-item ${claseItem}" 
                         style="${cursor}"
                         onclick="${p.evaluado ? '' : 'abrirModalEvaluacion(' + p.id + ')'}">
                        <div>
                            <div class="participante-nombre">
                                ${p.evaluado ? '<i class="fas fa-lock"></i> ' : ''}
                                ${p.nombre}
                            </div>
                            <small class="text-muted">${p.institucion || ''}</small>
                        </div>
                        <span class="badge-status ${p.evaluado ? 'badge-evaluado' : 'badge-pendiente'}">
                            ${p.evaluado ? '<i class="fas fa-check-circle"></i> Evaluado y Bloqueado' : '<i class="fas fa-clock"></i> Pendiente'}
                        </span>
                    </div>
                `;
            });
            
            container.html(html);
        }

        // ========================================
        // SSE - CRON√ìMETRO EN TIEMPO REAL
        // ========================================
        function iniciarSSE() {
            if (eventSource) {
                console.log('üîå Cerrando eventSource previo');
                eventSource.close();
            }

            const SSE_URL = '/jurado/cronometro/stream';
            console.log('üîå Conectando SSE a', SSE_URL);
            eventSource = new EventSource(SSE_URL);

            eventSource.onopen = function() {
                console.log('‚úÖ SSE abierto');
            };

            eventSource.addEventListener('cronometro', function(event) {
                // event.data viene como JSON del servidor (lastState o actualizaciones)
                try {
                    const data = JSON.parse(event.data);
                    console.log('üì° Cron√≥metro actualizado (cliente):', data);

                    // Mantener referencia global del participante en presentaci√≥n
                    if (data.participanteId || data.participanteNombre) {
                        participanteEnPresentacion = {
                            id: data.participanteId,
                            nombre: data.participanteNombre
                        };
                    }

                    // Llamar al actualizador con todo el objeto
                    actualizarCronometro(data);
                } catch (e) {
                    console.warn('‚ö†Ô∏è No JSON en cronometro:', event.data);
                }
            });

            eventSource.addEventListener('heartbeat', function(e) {
                // opcional: console.log('heartbeat', e.data);
            });

            eventSource.onerror = function(err) {
                console.error('‚ùå Error en SSE (cliente):', err);
                // reintentar conexi√≥n si falla
                setTimeout(iniciarSSE, 5000);
            };
        }




        function actualizarCronometro(data) {
            const $cronometro = $('#cronometroFlotante');
            const $participante = $('#cronometroParticipante');
            const $tiempo = $('#cronometroTiempo');
            const $estado = $('#cronometroEstado');

            // Si vienen campos de participante, actualizarlos
            if (data.participanteId || data.participanteNombre) {
                participanteEnPresentacion = {
                    id: data.participanteId,
                    nombre: data.participanteNombre
                };
            }

            // Si es iniciar: mostrar cron√≥metro con participante y estado inicial
            if (data.accion === 'iniciar') {
                $participante.html(`<i class="fas fa-user"></i> ${data.participanteNombre || '-'}`);
                $cronometro.addClass('activo');
                // mostrar tambi√©n dentro del modal si est√° abierto y es el mismo participante
                sincronizarCronometroModal(data);
                renderizarParticipantes();

                if (navigator.vibrate) navigator.vibrate(200);
                return;
            }

            // Si es actualizar: actualizar tiempo, estado y asegurarse de que el cron√≥metro est√© visible
            if (data.accion === 'actualizar') {
                const minutos = Math.floor(data.tiempoRestante / 60);
                const segundos = data.tiempoRestante % 60;
                const display = `${minutos}:${segundos.toString().padStart(2, '0')}`;

                $tiempo.text(display);

                // Asegurarnos que el cron√≥metro est√© visible (por reconexiones)
                $cronometro.addClass('activo');

                // Cambiar colores seg√∫n estado
                $tiempo.removeClass('verde amarillo rojo').addClass(data.estado || 'verde');
                $estado.removeClass('verde amarillo rojo').addClass(data.estado || 'verde');

                if (data.estado === 'verde') {
                    $estado.html('<i class="fas fa-play-circle"></i> En curso');
                } else if (data.estado === 'amarillo') {
                    $estado.html('<i class="fas fa-exclamation-triangle"></i> ¬°√öltimos 3 min!');
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                } else if (data.estado === 'rojo') {
                    $estado.html('<i class="fas fa-stop-circle"></i> ¬°Tiempo finalizado!');
                }

                // Si el modal est√° abierto para este participante, sincronizar el modal
                sincronizarCronometroModal(data);
                return;
            }

            // Si es finalizar: ocultar
            if (data.accion === 'finalizar') {
                $cronometro.removeClass('activo');
                participanteEnPresentacion = null;
                renderizarParticipantes();
                ocultarCronometroEnModal();
            }

            // Si es un ping/otro: ignorar o manejar seg√∫n convenga
        }


        function abrirModalEvaluacion(idParticipante) {
            const participante = datosCompletos.participantes.find(p => p.id === idParticipante);
            
            if (!participante) {
                alert('‚ùå No se encontr√≥ el participante');
                return;
            }
            
            if (participante.evaluado) {
                mostrarEvaluacionBloqueada(participante);
                return;
            }
            
            participanteSeleccionado = participante;
            
            $('#nombreParticipanteModal').text(participante.nombre);
            $('#estadoEvaluacion').hide();
            
            let html = '';
            let totalMax = 0;
            
            datosCompletos.criterios.forEach(function(criterio) {
                totalMax += criterio.maxPuntos;
                const valor = participante.puntajes[criterio.id] || 0;
                
                html += `
                    <div class="criterio-box">
                        <div class="criterio-nombre">${criterio.nombre}</div>
                        ${criterio.descripcion ? `<small class="text-muted">${criterio.descripcion}</small>` : ''}
                        <div class="criterio-info mt-2">
                            <span>Puntaje m√°ximo: <strong>${criterio.maxPuntos} pts</strong></span>
                        </div>
                        <input type="number" 
                            class="input-puntaje" 
                            id="criterio_${criterio.id}"
                            min="0" 
                            max="${criterio.maxPuntos}" 
                            step="0.5"
                            value="${valor}"
                            onchange="calcularTotal()"
                            oninput="validarPuntaje(this, ${criterio.maxPuntos})"
                            placeholder="0.0">
                    </div>
                `;
            });
            
            $('#criteriosContainer').html(html);
            $('#totalMax').text(totalMax);
            $('.btn-guardar').show().prop('disabled', false);
            $('.btn-cerrar').text('Cancelar');
        
            calcularTotal();

            if (participanteEnPresentacion && participanteEnPresentacion.id === participante.id) {
                mostrarCronometroEnModal(participanteEnPresentacion);
            } else {
                ocultarCronometroEnModal();
            }

            
            $('#modalEvaluacion').addClass('show');
        }
        
        function mostrarEvaluacionBloqueada(participante) {
            $('#nombreParticipanteModal').text(participante.nombre);
            $('#estadoEvaluacion')
                .removeClass('badge-pendiente')
                .addClass('badge-evaluado')
                .html('<i class="fas fa-lock"></i> Bloqueado')
                .show();
            
            let html = '';
            let totalMax = 0;
            let totalObtenido = 0;
            
            datosCompletos.criterios.forEach(function(criterio) {
                totalMax += criterio.maxPuntos;
                const valor = participante.puntajes[criterio.id] || 0;
                totalObtenido += valor;
                
                html += `
                    <div class="criterio-box" style="background: #f8f9fa; opacity: 0.8;">
                        <div class="criterio-nombre">
                            <i class="fas fa-lock"></i> ${criterio.nombre}
                        </div>
                        ${criterio.descripcion ? `<small class="text-muted">${criterio.descripcion}</small>` : ''}
                        <div class="criterio-info mt-2">
                            <span>Puntaje m√°ximo: <strong>${criterio.maxPuntos} pts</strong></span>
                        </div>
                        <input type="number" 
                            class="input-puntaje" 
                            value="${valor}"
                            disabled
                            style="background: #e9ecef; cursor: not-allowed;">
                    </div>
                `;
            });
            
            $('#criteriosContainer').html(html);
            $('#totalMax').text(totalMax);
            $('#totalPuntos').text(totalObtenido.toFixed(1));
            
            $('.btn-guardar').hide();
            $('.btn-cerrar').text('Cerrar');
            
            $('#modalEvaluacion').addClass('show');
        }

        function validarPuntaje(input, max) {
            let valor = parseFloat(input.value) || 0;
            
            if (valor < 0) {
                input.value = 0;
            } else if (valor > max) {
                input.value = max;
            }
            
            calcularTotal();
        }

        function calcularTotal() {
            let total = 0;
            datosCompletos.criterios.forEach(function(criterio) {
                const input = $('#criterio_' + criterio.id);
                const valor = parseFloat(input.val()) || 0;
                total += valor;
            });
            $('#totalPuntos').text(total.toFixed(1));
        }

        function cerrarModal() {
            $('#modalEvaluacion').removeClass('show');
            participanteSeleccionado = null;
            ocultarCronometroEnModal();
        }

        function guardarEvaluacion() {
            if (!participanteSeleccionado) {
                alert('‚ùå No se ha seleccionado un participante');
                return;
            }
            
            let todosCompletos = true;
            const puntajes = {};
            
            datosCompletos.criterios.forEach(function(criterio) {
                const input = $('#criterio_' + criterio.id);
                const valor = parseFloat(input.val());
                
                if (isNaN(valor) || valor < 0) {
                    todosCompletos = false;
                }
                
                puntajes[criterio.id] = valor || 0;
            });
            
            if (!todosCompletos) {
                alert('‚ö†Ô∏è Por favor completa todos los criterios con valores v√°lidos');
                return;
            }
            
            const total = parseFloat($('#totalPuntos').text());

            const evaluacionData = {
                idParticipante: participanteSeleccionado.id,
                puntajes: puntajes,
                total: total
            };
            
            $('.btn-guardar').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');
            
            $.ajax({
                url: '/jurado/guardar',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(evaluacionData),
                success: function(response) {
                    
                    if (response.success) {
                        participanteSeleccionado.evaluado = true;
                        participanteSeleccionado.puntajes = puntajes;
                        
                        cerrarModal();
                        renderizarParticipantes();
                        actualizarProgreso();
                    } else {
                        alert('‚ùå Error: ' + (response.message || 'Error desconocido'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error al guardar:', xhr.responseText);
                    alert('‚ùå Error al guardar la evaluaci√≥n. Por favor, intenta nuevamente.');
                    $('.btn-guardar').prop('disabled', false).html('<i class="fas fa-save"></i> Guardar');
                }
            });
        }

        function actualizarProgreso() {
            if (!datosCompletos || !datosCompletos.participantes) return;
            
            const total = datosCompletos.participantes.length;
            const evaluados = datosCompletos.participantes.filter(p => p.evaluado).length;
            const porcentaje = total > 0 ? Math.round((evaluados / total) * 100) : 0;
            
            $('#textoProgreso').text(evaluados + ' de ' + total + ' evaluados');
            $('#barraProgreso').css('width', porcentaje + '%').text(porcentaje + '%');
            
            const estadoBadge = $('#estadoGeneral');
            if (porcentaje === 100) {
                estadoBadge
                    .removeClass('bg-secondary bg-warning')
                    .addClass('bg-success')
                    .html('<i class="fas fa-check-circle"></i> Completado');
            } else if (porcentaje > 0) {
                estadoBadge
                    .removeClass('bg-secondary bg-success')
                    .addClass('bg-warning')
                    .html('<i class="fas fa-hourglass-half"></i> ' + porcentaje + '% completado');
            }
        }

        function verificarCompletitud() {
            if (!datosCompletos || !datosCompletos.participantes) return;
            const total = datosCompletos.participantes.length;
            const evaluados = datosCompletos.participantes.filter(p => p.evaluado).length;
            if (evaluados === total) {
                $('#mensajeCompleto').slideDown();
                $.ajax({
                    url: '/jurado/notificar-completado',
                    method: 'POST',
                    success: function(response) {
                        console.log('‚úÖ Notificaci√≥n enviada:', response);
                    }
                });
            }
        }

        function segundosToDisplay(t) {
            const m = Math.floor(t / 60);
            const s = t % 60;
            return `${m}:${s.toString().padStart(2,'0')}`;
        }

        function sincronizarCronometroModal(data) {
            // Si el modal NO est√° visible, no hacemos nada (lo mostramos al abrir si corresponde)
            if (!$('#modalEvaluacion').hasClass('show')) return;

            // Determinar si el participante del modal coincide con el participante en presentaci√≥n
            const modalParticipantName = $('#nombreParticipanteModal').text();
            const modalMatches = participanteEnPresentacion && 
                                (participanteEnPresentacion.id === data.participanteId ||
                                participanteEnPresentacion.nombre === modalParticipantName);

            if (!modalMatches) {
                // Si el modal no corresponde al participante en presentaci√≥n, ocultamos el cron√≥metro en modal
                ocultarCronometroEnModal();
                return;
            }

            // Mostrar y sincronizar
            const nombre = data.participanteNombre || (participanteEnPresentacion && participanteEnPresentacion.nombre) || '-';
            $('#modalCronometroParticipante').html(`<i class="fas fa-user"></i> ${nombre}`);

            if (typeof data.tiempoRestante !== 'undefined' && data.tiempoRestante !== null) {
                $('#modalCronometroTiempo').text(segundosToDisplay(data.tiempoRestante));
            } else {
                // fallback: tomar del cronometro flotante
                $('#modalCronometroTiempo').text($('#cronometroTiempo').text());
            }

            // copiar clases/estado del cronometro flotante
            const clase = $('#cronometroTiempo').hasClass('amarillo') ? 'amarillo' :
                        $('#cronometroTiempo').hasClass('rojo') ? 'rojo' : 'verde';
            $('#modalCronometroTiempo').removeClass('verde amarillo rojo').addClass(clase);
            $('#modalCronometroEstado').html($('#cronometroEstado').html());

            $('#modalCronometro').show();
        }

        
        function mostrarCronometroEnModal(participante) {
            // llamada p√∫blica: abrir modal y mostrar cronometro basado en participanteEnPresentacion
            if (!participante) participante = participanteEnPresentacion;
            if (!participante) return;

            $('#modalCronometroParticipante').html(`<i class="fas fa-user"></i> ${participante.nombre || '-'}`);
            // sincronizar display del cronometro principal
            $('#modalCronometroTiempo').text($('#cronometroTiempo').text());
            const clase = $('#cronometroTiempo').hasClass('amarillo') ? 'amarillo' :
                        $('#cronometroTiempo').hasClass('rojo') ? 'rojo' : 'verde';
            $('#modalCronometroTiempo').removeClass('verde amarillo rojo').addClass(clase);
            $('#modalCronometroEstado').html($('#cronometroEstado').html());
            $('#modalCronometro').show();
        }

        function ocultarCronometroEnModal() {
            $('#modalCronometro').hide();
        }

        $(document).on('click', '.modal-evaluacion', function(e) {
            if (e.target === this) {
                cerrarModal();
            }
        });

        window.addEventListener('beforeunload', function(e) {
            if (!datosCompletos || !datosCompletos.participantes) return;
            const hayPendientes = datosCompletos.participantes.some(p => !p.evaluado);
            if (hayPendientes) {
                e.preventDefault();
                e.returnValue = 'Tienes evaluaciones pendientes. ¬øEst√°s seguro de salir?';
            }
        });
    </script>
</body>
</html>