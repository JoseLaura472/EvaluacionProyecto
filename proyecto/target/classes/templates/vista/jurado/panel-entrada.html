<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación de Danzas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        /* ═══════════════════════════════════════════════════════════
           NAVBAR
           ═══════════════════════════════════════════════════════════ */

        .navbar-jurado {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 0;
            margin-bottom: 20px;
        }

        .navbar-brand {
            font-weight: bold;
            color: #667eea !important;
            font-size: 1.3rem;
        }

        .navbar-brand i {
            color: #764ba2;
            margin-right: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin: 0;
        }

        .user-role {
            font-size: 12px;
            color: #666;
            margin: 0;
        }

        .btn-logout {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
            color: white;
        }

        /* ═══════════════════════════════════════════════════════════
           CONTENEDOR PRINCIPAL
           ═══════════════════════════════════════════════════════════ */

        .container-custom {
            max-width: 900px;
            margin: 0 auto;
        }
        .header-box {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        .header-title {
            color: #667eea;
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }
        .categoria-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            margin-top: 10px;
            font-weight: 600;
        }
        .lista-participantes {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .participante-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .participante-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        .participante-item.evaluado {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .participante-nombre {
            font-weight: 600;
            color: #333;
        }
        .badge-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-evaluado {
            background: #28a745;
            color: white;
        }
        .badge-pendiente {
            background: #ffc107;
            color: #333;
        }
        .resumen-box {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .progress-custom {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar-custom {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 0.5s;
        }
        /* Modal */
        .modal-evaluacion {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            overflow-y: auto;
        }
        .modal-evaluacion.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content-custom {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header-custom {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
        }
        .modal-body-custom {
            padding: 25px;
        }
        .criterio-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .criterio-nombre {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        .input-puntaje {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }
        .total-box {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
        .total-puntos {
            font-size: 32px;
            font-weight: bold;
        }
        .btn-custom {
            padding: 12px 30px;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-guardar {
            background: #28a745;
            color: white;
            flex: 1;
        }
        .btn-guardar:hover {
            background: #218838;
        }
        .btn-cerrar {
            background: #6c757d;
            color: white;
            flex: 1;
        }
        .btn-cerrar:hover {
            background: #5a6268;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
        }
        /* Participante bloqueado */
        .participante-item.bloqueado {
            background: #f8f9fa !important;
            border-left: 4px solid #28a745;
            cursor: not-allowed !important;
        }

        .participante-item.bloqueado:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* Mensaje de completado */
        #mensajeCompleto {
            animation: slideIn 0.5s ease-out;
            border-left: 5px solid #28a745;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal header con estado */
        .modal-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #estadoEvaluacion {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-jurado">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#">
                <i class="fas fa-clipboard-check"></i>
                Panel de Evaluación
            </a>
            
            <div class="user-info">
                <!-- Avatar con iniciales -->
                <div class="user-avatar" th:text="${jurado.persona.nombres != null ? jurado.persona.nombres.substring(0,1) : 'J'}">
                    J
                </div>
                
                <!-- Información del usuario -->
                <div class="user-details">
                    <p class="user-name" th:text="${jurado.persona.nombreCompleto}">Juan Pérez</p>
                    <p class="user-role">
                        <i class="fas fa-user-shield"></i> Jurado - 
                        <span th:text="${nombreCategoria}">Categoría</span>
                    </p>
                </div>
                
                <!-- Botón cerrar sesión -->
                <a href="/cerrar_sesionAdm" id="btnCerrarSesion" class="btn btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </a>
            </div>
        </div>
    </nav>
    <div class="container-custom">
        <div class="header-box">
            <h1 class="header-title">
                <i class="fas fa-clipboard-check"></i> Panel de Evaluación
            </h1>
            <div class="mt-3">
                <small class="text-muted">
                    Jurado: <strong th:text="${jurado.persona.nombreCompleto}">Juan Pérez</strong>
                </small>
                <br>
                <span class="categoria-badge">
                    <i class="fas fa-tag"></i> <span th:text="${nombreCategoria}">Categoría A</span>
                </span>
            </div>
        </div>
        <div class="lista-participantes">
            <h5 class="mb-3">
                <i class="fas fa-users"></i> Participantes a evaluar:
            </h5>
            <div id="listaParticipantes"></div>
        </div>
        <div class="resumen-box">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <strong>Progreso:</strong>
                    <span id="textoProgreso">0 de 0 evaluados</span>
                </div>
                <span id="estadoGeneral" class="badge bg-secondary">
                    <i class="fas fa-hourglass-half"></i> En progreso
                </span>
            </div>
            <div class="progress-custom">
                <div class="progress-bar-custom" id="barraProgreso" style="width: 0%">0%</div>
            </div>
        </div>
        <div id="mensajeCompleto" class="alert alert-success" style="display: none;">
            <i class="fas fa-check-circle"></i>
            <strong>¡Evaluaciones completadas!</strong>
            <p class="mb-0">Has evaluado a todos los participantes. Las evaluaciones han sido guardadas automáticamente.</p>
        </div>
    </div>

    <div class="modal-evaluacion" id="modalEvaluacion">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h3 style="margin: 0;">
                    <i class="fas fa-edit"></i> <span id="nombreParticipanteModal">-</span>
                </h3>
                <span id="estadoEvaluacion" class="badge badge-status" style="display: none;"></span>
            </div>
            <div class="modal-body-custom">
                <div id="criteriosContainer"></div>
                
                <div class="total-box">
                    <div class="total-label">TOTAL</div>
                    <div class="total-puntos">
                        <span id="totalPuntos">0</span> / <span id="totalMax">50</span>
                    </div>
                </div>
                
                <div class="d-flex" style="gap: 10px;">
                    <button class="btn-custom btn-cerrar" onclick="cerrarModal()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                    <button class="btn-custom btn-guardar" onclick="guardarEvaluacion()">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="javascript">
        let faseActual = 'recorrido';
        let participanteSeleccionado = null;
        let datosCompletos = {};
        const idActividad = /*[[${idActividad}]]*/ null;

        document.addEventListener('DOMContentLoaded', () => {
            const btnCerrarSesion = document.getElementById('btnCerrarSesion');
            
            if (btnCerrarSesion) {
                btnCerrarSesion.addEventListener('click', async (e) => {
                    e.preventDefault(); 
                    
                    const urlCerrarSesion = btnCerrarSesion.href;

                    const cerrarSesion = () => {
                        window.location.href = urlCerrarSesion;
                    };

                    if (datosCompletos && datosCompletos.participantes) {
                        const total = datosCompletos.participantes.length;
                        const evaluados = datosCompletos.participantes.filter(p => p.evaluado).length;
                        const hayPendientes = total > evaluados;

                        let resultado;

                        if (hayPendientes) {
                            resultado = await Swal.fire({
                                title: '⚠️ Advertencia',
                                html: `Tienes **${total - evaluados}** evaluaciones pendientes.<br><br>Si cierras sesión ahora, podrás continuar después, pero las evaluaciones pendientes seguirán sin completarse.`,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Sí, cerrar sesión',
                                cancelButtonText: 'Cancelar',
                                confirmButtonColor: '#d33'
                            });

                        } else {
                            resultado = await Swal.fire({
                                title: '✅ ¡Evaluaciones completadas!',
                                text: 'Has completado todas tus evaluaciones. ¿Deseas cerrar sesión?',
                                icon: 'success',
                                showCancelButton: true,
                                confirmButtonText: 'Sí, cerrar sesión',
                                cancelButtonText: 'Cancelar'
                            });
                        }
                        
                        if (resultado.isConfirmed) {
                            cerrarSesion();
                        }
                        
                    } else {
                        const resultado = await Swal.fire({
                            title: '¿Cerrar Sesión?',
                            text: '¿Estás seguro de que deseas cerrar sesión?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: 'Sí, cerrar sesión',
                            cancelButtonText: 'Cancelar'
                        });

                        if (resultado.isConfirmed) {
                            cerrarSesion();
                        }
                    }
                });
            }
        });

        $(document).ready(function() {cargarDatos();});

        function cargarDatos() {
            $.ajax({
                url: '/jurado/datos/' + idActividad,
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (!response.success) {
                        alert('❌ Error: ' + (response.message || 'Error desconocido'));
                        return;
                    }
                    
                    datosCompletos = response.categoria;
                    renderizarParticipantes();
                    actualizarProgreso();
                },
                error: function(xhr, status, error) {
                    console.error('❌ Error al cargar datos:', error);
                    console.error('Response:', xhr.responseText);
                    alert('❌ Error al cargar los datos de evaluación. Por favor, recarga la página.');
                }
            });
        }

        function renderizarParticipantes() {
            const container = $('#listaParticipantes');
            
            if (!datosCompletos || !datosCompletos.participantes || datosCompletos.participantes.length === 0) {
                container.html(`
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <div>No hay participantes para evaluar</div>
                    </div>
                `);
                return;
            }
            
            let html = '';
            datosCompletos.participantes.forEach(function(p) {
                const claseItem = p.evaluado ? 'evaluado bloqueado' : '';
                const cursor = p.evaluado ? 'cursor: not-allowed; opacity: 0.7;' : 'cursor: pointer;';
                
                html += `
                    <div class="participante-item ${claseItem}" 
                         style="${cursor}"
                         onclick="${p.evaluado ? '' : 'abrirModalEvaluacion(' + p.id + ')'}">
                        <div>
                            <div class="participante-nombre">
                                ${p.evaluado ? '<i class="fas fa-lock"></i> ' : ''}
                                ${p.nombre}
                            </div>
                            <small class="text-muted">${p.institucion || ''}</small>
                        </div>
                        <span class="badge-status ${p.evaluado ? 'badge-evaluado' : 'badge-pendiente'}">
                            ${p.evaluado ? '<i class="fas fa-check-circle"></i> Evaluado y Bloqueado' : '<i class="fas fa-clock"></i> Pendiente'}
                        </span>
                    </div>
                `;
            });
            
            container.html(html);
        }

        function abrirModalEvaluacion(idParticipante) {
            const participante = datosCompletos.participantes.find(p => p.id === idParticipante);
            
            if (!participante) {
                alert('❌ No se encontró el participante');
                return;
            }
            
            if (participante.evaluado) {
                mostrarEvaluacionBloqueada(participante);
                return;
            }
            
            participanteSeleccionado = participante;
            
            $('#nombreParticipanteModal').text(participante.nombre);
            $('#estadoEvaluacion').hide();
            
            let html = '';
            let totalMax = 0;
            
            datosCompletos.criterios.forEach(function(criterio) {
                totalMax += criterio.maxPuntos;
                const valor = participante.puntajes[criterio.id] || 0;
                
                html += `
                    <div class="criterio-box">
                        <div class="criterio-nombre">${criterio.nombre}</div>
                        ${criterio.descripcion ? `<small class="text-muted">${criterio.descripcion}</small>` : ''}
                        <div class="criterio-info mt-2">
                            <span>Puntaje máximo: <strong>${criterio.maxPuntos} pts</strong></span>
                        </div>
                        <input type="number" 
                            class="input-puntaje" 
                            id="criterio_${criterio.id}"
                            min="0" 
                            max="${criterio.maxPuntos}" 
                            step="0.5"
                            value="${valor}"
                            onchange="calcularTotal()"
                            oninput="validarPuntaje(this, ${criterio.maxPuntos})"
                            placeholder="0.0">
                    </div>
                `;
            });
            
            $('#criteriosContainer').html(html);
            $('#totalMax').text(totalMax);
            $('.btn-guardar').show().prop('disabled', false);
            $('.btn-cerrar').text('Cancelar');
        
            calcularTotal();
            
            $('#modalEvaluacion').addClass('show');
        }
        
        function mostrarEvaluacionBloqueada(participante) {
            $('#nombreParticipanteModal').text(participante.nombre);
            $('#estadoEvaluacion')
                .removeClass('badge-pendiente')
                .addClass('badge-evaluado')
                .html('<i class="fas fa-lock"></i> Bloqueado')
                .show();
            
            let html = '';
            let totalMax = 0;
            let totalObtenido = 0;
            
            datosCompletos.criterios.forEach(function(criterio) {
                totalMax += criterio.maxPuntos;
                const valor = participante.puntajes[criterio.id] || 0;
                totalObtenido += valor;
                
                html += `
                    <div class="criterio-box" style="background: #f8f9fa; opacity: 0.8;">
                        <div class="criterio-nombre">
                            <i class="fas fa-lock"></i> ${criterio.nombre}
                        </div>
                        ${criterio.descripcion ? `<small class="text-muted">${criterio.descripcion}</small>` : ''}
                        <div class="criterio-info mt-2">
                            <span>Puntaje máximo: <strong>${criterio.maxPuntos} pts</strong></span>
                        </div>
                        <input type="number" 
                            class="input-puntaje" 
                            value="${valor}"
                            disabled
                            style="background: #e9ecef; cursor: not-allowed;">
                    </div>
                `;
            });
            
            $('#criteriosContainer').html(html);
            $('#totalMax').text(totalMax);
            $('#totalPuntos').text(totalObtenido.toFixed(1));
            
            $('.btn-guardar').hide();
            $('.btn-cerrar').text('Cerrar');
            
            $('#modalEvaluacion').addClass('show');
        }

        function validarPuntaje(input, max) {
            let valor = parseFloat(input.value) || 0;
            
            if (valor < 0) {
                input.value = 0;
            } else if (valor > max) {
                input.value = max;
            }
            
            calcularTotal();
        }

        function calcularTotal() {
            let total = 0;
            datosCompletos.criterios.forEach(function(criterio) {
                const input = $('#criterio_' + criterio.id);
                const valor = parseFloat(input.val()) || 0;
                total += valor;
            });
            $('#totalPuntos').text(total.toFixed(1));
        }

        function cerrarModal() {
            $('#modalEvaluacion').removeClass('show');
            participanteSeleccionado = null;
        }

        function guardarEvaluacion() {
            if (!participanteSeleccionado) {
                alert('❌ No se ha seleccionado un participante');
                return;
            }
            
            let todosCompletos = true;
            const puntajes = {};
            
            datosCompletos.criterios.forEach(function(criterio) {
                const input = $('#criterio_' + criterio.id);
                const valor = parseFloat(input.val());
                
                if (isNaN(valor) || valor < 0) {
                    todosCompletos = false;
                }
                
                puntajes[criterio.id] = valor || 0;
            });
            
            if (!todosCompletos) {
                alert('⚠️ Por favor completa todos los criterios con valores válidos');
                return;
            }
            
            const total = parseFloat($('#totalPuntos').text());

            const evaluacionData = {
                idParticipante: participanteSeleccionado.id,
                puntajes: puntajes,
                total: total
            };
            
            $('.btn-guardar').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');
            
            $.ajax({
                url: '/jurado/guardar',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(evaluacionData),
                success: function(response) {
                    
                    if (response.success) {
                        participanteSeleccionado.evaluado = true;
                        participanteSeleccionado.puntajes = puntajes;
                        
                        cerrarModal();
                        renderizarParticipantes();
                        actualizarProgreso();
                    } else {
                        alert('❌ Error: ' + (response.message || 'Error desconocido'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('❌ Error al guardar:', xhr.responseText);
                    alert('❌ Error al guardar la evaluación. Por favor, intenta nuevamente.');
                    $('.btn-guardar').prop('disabled', false).html('<i class="fas fa-save"></i> Guardar');
                }
            });
        }

        function actualizarProgreso() {
            if (!datosCompletos || !datosCompletos.participantes) return;
            
            const total = datosCompletos.participantes.length;
            const evaluados = datosCompletos.participantes.filter(p => p.evaluado).length;
            const porcentaje = total > 0 ? Math.round((evaluados / total) * 100) : 0;
            
            $('#textoProgreso').text(evaluados + ' de ' + total + ' evaluados');
            $('#barraProgreso').css('width', porcentaje + '%').text(porcentaje + '%');
            
            const estadoBadge = $('#estadoGeneral');
            if (porcentaje === 100) {
                estadoBadge
                    .removeClass('bg-secondary bg-warning')
                    .addClass('bg-success')
                    .html('<i class="fas fa-check-circle"></i> Completado');
            } else if (porcentaje > 0) {
                estadoBadge
                    .removeClass('bg-secondary bg-success')
                    .addClass('bg-warning')
                    .html('<i class="fas fa-hourglass-half"></i> ' + porcentaje + '% completado');
            }
        }

        function verificarCompletitud() {
            if (!datosCompletos || !datosCompletos.participantes) return;
            const total = datosCompletos.participantes.length;
            const evaluados = datosCompletos.participantes.filter(p => p.evaluado).length;
            if (evaluados === total) {
                $('#mensajeCompleto').slideDown();
                $.ajax({
                    url: '/jurado/notificar-completado',
                    method: 'POST',
                    success: function(response) {
                        console.log('✅ Notificación enviada:', response);
                    }
                });
            }
        }

        const eventSource = new EventSource('/api/concurso/stream');
        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.accion === 'iniciar') {
                mostrarCronometroEnModal(data.participante);
            }
        };

        $(document).on('click', '.modal-evaluacion', function(e) {
            if (e.target === this) {
                cerrarModal();
            }
        });

        window.addEventListener('beforeunload', function(e) {
            if (!datosCompletos || !datosCompletos.participantes) return;
            const hayPendientes = datosCompletos.participantes.some(p => !p.evaluado);
            if (hayPendientes) {
                e.preventDefault();
                e.returnValue = 'Tienes evaluaciones pendientes. ¿Estás seguro de salir?';
            }
        });
    </script>
</body>
</html>