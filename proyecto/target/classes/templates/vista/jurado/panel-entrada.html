<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n de Danzas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/style-vista-entrada.css">
</head>
<body>
    <nav class="navbar navbar-jurado">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#">
                <i class="fas fa-clipboard-check"></i>
                Panel de Evaluaci√≥n
            </a>
            <div class="user-info">
                <a href="/cerrar_sesionAdm" id="btnCerrarSesion" class="btn btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </a>
            </div>
        </div>
    </nav>
    <!-- CRON√ìMETRO FLOTANTE -->
    <div class="cronometro-flotante" id="cronometroFlotante">
        <div class="cronometro-participante" id="cronometroParticipante">
            <i class="fas fa-user"></i> -
        </div>
        <div class="cronometro-tiempo verde" id="cronometroTiempo">15:00</div>
        <div class="cronometro-estado verde" id="cronometroEstado">
            <i class="fas fa-play-circle"></i> En curso
        </div>
    </div>
    <div class="container-custom">
        <div class="header-box">
            <h1 class="header-title">
                <i class="fas fa-clipboard-check"></i> Panel de Evaluaci√≥n
            </h1>
            <div class="mt-3">
                <small class="text-muted">
                    Jurado: <strong th:text="${jurado.persona.nombreCompleto}">Juan P√©rez</strong>
                </small>
                <br>
                <span class="categoria-badge">
                    <i class="fas fa-tag"></i> <span th:text="${nombreCategoria}">Categor√≠a A</span>
                </span>
            </div>
        </div>
        <div class="lista-participantes">
            <h5 class="mb-3">
                <i class="fas fa-users"></i> Participantes a evaluar:
            </h5>
            <div id="listaParticipantes"></div>
        </div>
        <div class="resumen-box">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <strong>Progreso:</strong>
                    <span id="textoProgreso">0 de 0 evaluados</span>
                </div>
                <span id="estadoGeneral" class="badge bg-secondary">
                    <i class="fas fa-hourglass-half"></i> En progreso
                </span>
            </div>
            <div class="progress-custom">
                <div class="progress-bar-custom" id="barraProgreso" style="width: 0%">0%</div>
            </div>
        </div>
        <div id="mensajeCompleto" class="alert alert-success" style="display: none;">
            <i class="fas fa-check-circle"></i>
            <strong>¬°Evaluaciones completadas!</strong>
            <p class="mb-0">Has evaluado a todos los participantes. Las evaluaciones han sido guardadas autom√°ticamente.</p>
        </div>
    </div>

    <div class="modal-evaluacion" id="modalEvaluacion">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h3 style="margin: 0;">
                    <i class="fas fa-edit"></i> <span id="nombreParticipanteModal">-</span>
                </h3>
                <span id="estadoEvaluacion" class="badge badge-status" style="display: none;"></span>
            </div>
            <div class="modal-body-custom">
                <!-- Dentro de modal-body-custom, antes de #criteriosContainer -->
                <div id="modalCronometro" style="display:none; margin-bottom: 1rem;">
                    <div class="modal-cronometro">
                        <div class="modal-cronometro-participante" id="modalCronometroParticipante"><i class="fas fa-user"></i> -</div>
                        <div class="modal-cronometro-tiempo verde" id="modalCronometroTiempo">15:00</div>
                        <div class="modal-cronometro-estado verde" id="modalCronometroEstado"><i class="fas fa-play-circle"></i> En curso</div>
                    </div>
                </div>

                <div id="criteriosContainer"></div>
                
                <div class="total-box">
                    <div class="total-label">TOTAL</div>
                    <div class="total-puntos">
                        <span id="totalPuntos">0</span> / <span id="totalMax">50</span>
                    </div>
                </div>
                
                <div class="d-flex" style="gap: 10px;">
                    <button class="btn-custom btn-cerrar" onclick="cerrarModal()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                    <button class="btn-custom btn-guardar" onclick="guardarEvaluacion()">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="javascript">
        let faseActual = 'recorrido';
        let eventSource = null;   // <- usar let, no const
        let participanteEnPresentacion = null;

        let participanteSeleccionado = null;
        let datosCompletos = {};
        const idActividad = /*[[${idActividad}]]*/ null;

        document.addEventListener('DOMContentLoaded', () => {
            const btnCerrarSesion = document.getElementById('btnCerrarSesion');
            
            if (btnCerrarSesion) {
                btnCerrarSesion.addEventListener('click', async (e) => {
                    e.preventDefault(); 
                    
                    const urlCerrarSesion = btnCerrarSesion.href;

                    const cerrarSesion = () => {
                        window.location.href = urlCerrarSesion;
                    };

                    if (datosCompletos && datosCompletos.participantes) {
                        const total = datosCompletos.participantes.length;
                        const evaluados = datosCompletos.participantes.filter(p => p.evaluado).length;
                        const hayPendientes = total > evaluados;

                        let resultado;

                        if (hayPendientes) {
                            resultado = await Swal.fire({
                                title: '‚ö†Ô∏è Advertencia',
                                html: `Tienes **${total - evaluados}** evaluaciones pendientes.<br><br>Si cierras sesi√≥n ahora, podr√°s continuar despu√©s, pero las evaluaciones pendientes seguir√°n sin completarse.`,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'S√≠, cerrar sesi√≥n',
                                cancelButtonText: 'Cancelar',
                                confirmButtonColor: '#d33'
                            });

                        } else {
                            resultado = await Swal.fire({
                                title: '‚úÖ ¬°Evaluaciones completadas!',
                                text: 'Has completado todas tus evaluaciones. ¬øDeseas cerrar sesi√≥n?',
                                icon: 'success',
                                showCancelButton: true,
                                confirmButtonText: 'S√≠, cerrar sesi√≥n',
                                cancelButtonText: 'Cancelar'
                            });
                        }
                        
                        if (resultado.isConfirmed) {
                            cerrarSesion();
                        }
                        
                    } else {
                        const resultado = await Swal.fire({
                            title: '¬øCerrar Sesi√≥n?',
                            text: '¬øEst√°s seguro de que deseas cerrar sesi√≥n?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: 'S√≠, cerrar sesi√≥n',
                            cancelButtonText: 'Cancelar'
                        });

                        if (resultado.isConfirmed) {
                            cerrarSesion();
                        }
                    }
                });
            }
        });

        $(document).ready(function() {cargarDatos(); iniciarSSE();});

        function cargarDatos() {
            $.ajax({
                url: '/jurado/datos/' + idActividad,
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (!response.success) {
                        alert('‚ùå Error: ' + (response.message || 'Error desconocido'));
                        return;
                    }
                    
                    datosCompletos = response.categoria;
                    renderizarParticipantes();
                    actualizarProgreso();
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error al cargar datos:', error);
                    console.error('Response:', xhr.responseText);
                    alert('‚ùå Error al cargar los datos de evaluaci√≥n. Por favor, recarga la p√°gina.');
                }
            });
        }

        function renderizarParticipantes() {
            const container = $('#listaParticipantes');
            
            if (!datosCompletos || !datosCompletos.participantes || datosCompletos.participantes.length === 0) {
                container.html(`
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <div>No hay participantes para evaluar</div>
                    </div>
                `);
                return;
            }
            
            let html = '';
            datosCompletos.participantes.forEach(function(p) {
                const claseItem = p.evaluado ? 'evaluado bloqueado' : '';
                const cursor = p.evaluado ? 'cursor: not-allowed; opacity: 0.7;' : 'cursor: pointer;';
                
                html += `
                    <div class="participante-item ${claseItem}" 
                         style="${cursor}"
                         onclick="${p.evaluado ? '' : 'abrirModalEvaluacion(' + p.id + ')'}">
                        <div>
                            <div class="participante-nombre">
                                ${p.evaluado ? '<i class="fas fa-lock"></i> ' : ''}
                                ${p.nombre}
                            </div>
                            <small class="text-muted">${p.institucion || ''}</small>
                        </div>
                        <span class="badge-status ${p.evaluado ? 'badge-evaluado' : 'badge-pendiente'}">
                            ${p.evaluado ? '<i class="fas fa-check-circle"></i> Evaluado y Bloqueado' : '<i class="fas fa-clock"></i> Pendiente'}
                        </span>
                    </div>
                `;
            });
            
            container.html(html);
        }

        // ========================================
        // SSE - CRON√ìMETRO EN TIEMPO REAL
        // ========================================
        function iniciarSSE() {
            if (eventSource) {
                console.log('üîå Cerrando eventSource previo');
                eventSource.close();
            }

            const SSE_URL = '/jurado/cronometro/stream';
            eventSource = new EventSource(SSE_URL);

            // eventSource.onopen = function() {
            //     console.log('‚úÖ SSE abierto');
            // };

            eventSource.addEventListener('cronometro', function(event) {
                // event.data viene como JSON del servidor (lastState o actualizaciones)
                try {
                    const data = JSON.parse(event.data);

                    // Mantener referencia global del participante en presentaci√≥n
                    if (data.participanteId || data.participanteNombre) {
                        participanteEnPresentacion = {
                            id: data.participanteId,
                            nombre: data.participanteNombre
                        };
                    }

                    // Llamar al actualizador con todo el objeto
                    actualizarCronometro(data);
                } catch (e) {
                    console.warn('‚ö†Ô∏è No JSON en cronometro:', event.data);
                }
            });

            eventSource.addEventListener('heartbeat', function(e) {
                // opcional: console.log('heartbeat', e.data);
            });

            eventSource.onerror = function(err) {
                console.error('‚ùå Error en SSE (cliente):', err);
                // reintentar conexi√≥n si falla
                setTimeout(iniciarSSE, 5000);
            };
        }

        function actualizarCronometro(data) {
            const $cronometro = $('#cronometroFlotante');
            const $participante = $('#cronometroParticipante');
            const $tiempo = $('#cronometroTiempo');
            const $estado = $('#cronometroEstado');

            // Si vienen campos de participante, actualizarlos
            if (data.participanteId || data.participanteNombre) {
                participanteEnPresentacion = {
                    id: data.participanteId,
                    nombre: data.participanteNombre
                };
            }

            // Si es iniciar: mostrar cron√≥metro con participante y estado inicial
            if (data.accion === 'iniciar') {
                $participante.html(`<i class="fas fa-user"></i> ${data.participanteNombre || '-'}`);
                $cronometro.addClass('activo');
                // mostrar tambi√©n dentro del modal si est√° abierto y es el mismo participante
                sincronizarCronometroModal(data);
                renderizarParticipantes();

                if (navigator.vibrate) navigator.vibrate(200);
                return;
            }

            // Si es actualizar: actualizar tiempo, estado y asegurarse de que el cron√≥metro est√© visible
            if (data.accion === 'actualizar') {
                const minutos = Math.floor(data.tiempoRestante / 60);
                const segundos = data.tiempoRestante % 60;
                const display = `${minutos}:${segundos.toString().padStart(2, '0')}`;

                $tiempo.text(display);

                // Asegurarnos que el cron√≥metro est√© visible (por reconexiones)
                $cronometro.addClass('activo');

                // Cambiar colores seg√∫n estado
                $tiempo.removeClass('verde amarillo rojo').addClass(data.estado || 'verde');
                $estado.removeClass('verde amarillo rojo').addClass(data.estado || 'verde');

                if (data.estado === 'verde') {
                    $estado.html('<i class="fas fa-play-circle"></i> En curso');
                } else if (data.estado === 'amarillo') {
                    $estado.html('<i class="fas fa-exclamation-triangle"></i> ¬°√öltimos 3 min!');
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                } else if (data.estado === 'rojo') {
                    $estado.html('<i class="fas fa-stop-circle"></i> ¬°Tiempo finalizado!');
                }

                // Si el modal est√° abierto para este participante, sincronizar el modal
                sincronizarCronometroModal(data);
                return;
            }

            // Si es finalizar: ocultar
            if (data.accion === 'finalizar') {
                $cronometro.removeClass('activo');
                participanteEnPresentacion = null;
                renderizarParticipantes();
                ocultarCronometroEnModal();
            }

            // Si es un ping/otro: ignorar o manejar seg√∫n convenga
        }


        function abrirModalEvaluacion(idParticipante) {
            const participante = datosCompletos.participantes.find(p => p.id === idParticipante);
            
            if (!participante) {
                alert('‚ùå No se encontr√≥ el participante');
                return;
            }
            
            if (participante.evaluado) {
                mostrarEvaluacionBloqueada(participante);
                return;
            }
            
            participanteSeleccionado = participante;
            
            $('#nombreParticipanteModal').text(participante.nombre);
            $('#estadoEvaluacion').hide();
            
            let html = '';
            let totalMax = 0;
            
            datosCompletos.criterios.forEach(function(criterio) {
                totalMax += criterio.maxPuntos;
                const valor = participante.puntajes[criterio.id] || 0;
                
                html += `
                    <div class="criterio-box">
                        <div class="criterio-nombre">${criterio.nombre}</div>
                        ${criterio.descripcion ? `<small class="text-muted">${criterio.descripcion}</small>` : ''}
                        <div class="criterio-info mt-2">
                            <span>Puntaje m√°ximo: <strong>${criterio.maxPuntos} pts</strong></span>
                        </div>
                        <input type="number" 
                            class="input-puntaje" 
                            id="criterio_${criterio.id}"
                            min="0" 
                            max="${criterio.maxPuntos}" 
                            step="0.5"
                            value="${valor}"
                            onchange="calcularTotal()"
                            oninput="validarPuntaje(this, ${criterio.maxPuntos})"
                            placeholder="0.0">
                    </div>
                `;
            });
            
            $('#criteriosContainer').html(html);
            $('#totalMax').text(totalMax);
            $('.btn-guardar').show().prop('disabled', false);
            $('.btn-cerrar').text('Cancelar');
        
            calcularTotal();

            if (participanteEnPresentacion && participanteEnPresentacion.id === participante.id) {
                mostrarCronometroEnModal(participanteEnPresentacion);
            } else {
                ocultarCronometroEnModal();
            }

            
            $('#modalEvaluacion').addClass('show');
        }
        
        function mostrarEvaluacionBloqueada(participante) {
            $('#nombreParticipanteModal').text(participante.nombre);
            $('#estadoEvaluacion')
                .removeClass('badge-pendiente')
                .addClass('badge-evaluado')
                .html('<i class="fas fa-lock"></i> Bloqueado')
                .show();
            
            let html = '';
            let totalMax = 0;
            let totalObtenido = 0;
            
            datosCompletos.criterios.forEach(function(criterio) {
                totalMax += criterio.maxPuntos;
                const valor = participante.puntajes[criterio.id] || 0;
                totalObtenido += valor;
                
                html += `
                    <div class="criterio-box" style="background: #f8f9fa; opacity: 0.8;">
                        <div class="criterio-nombre">
                            <i class="fas fa-lock"></i> ${criterio.nombre}
                        </div>
                        ${criterio.descripcion ? `<small class="text-muted">${criterio.descripcion}</small>` : ''}
                        <div class="criterio-info mt-2">
                            <span>Puntaje m√°ximo: <strong>${criterio.maxPuntos} pts</strong></span>
                        </div>
                        <input type="number" 
                            class="input-puntaje" 
                            value="${valor}"
                            disabled
                            style="background: #e9ecef; cursor: not-allowed;">
                    </div>
                `;
            });
            
            $('#criteriosContainer').html(html);
            $('#totalMax').text(totalMax);
            $('#totalPuntos').text(totalObtenido.toFixed(1));
            
            $('.btn-guardar').hide();
            $('.btn-cerrar').text('Cerrar');
            
            $('#modalEvaluacion').addClass('show');
        }

        function validarPuntaje(input, max) {
            let valor = parseFloat(input.value) || 0;
            
            if (valor < 0) {
                input.value = 0;
            } else if (valor > max) {
                input.value = max;
            }
            
            calcularTotal();
        }

        function calcularTotal() {
            let total = 0;
            datosCompletos.criterios.forEach(function(criterio) {
                const input = $('#criterio_' + criterio.id);
                const valor = parseFloat(input.val()) || 0;
                total += valor;
            });
            $('#totalPuntos').text(total.toFixed(1));
        }

        function cerrarModal() {
            $('#modalEvaluacion').removeClass('show');
            participanteSeleccionado = null;
            ocultarCronometroEnModal();
        }

        function guardarEvaluacion() {
            if (!participanteSeleccionado) {
                alert('‚ùå No se ha seleccionado un participante');
                return;
            }
            
            let todosCompletos = true;
            const puntajes = {};
            
            datosCompletos.criterios.forEach(function(criterio) {
                const input = $('#criterio_' + criterio.id);
                const valor = parseFloat(input.val());
                
                if (isNaN(valor) || valor < 0) {
                    todosCompletos = false;
                }
                
                puntajes[criterio.id] = valor || 0;
            });
            
            if (!todosCompletos) {
                alert('‚ö†Ô∏è Por favor completa todos los criterios con valores v√°lidos');
                return;
            }
            
            const total = parseFloat($('#totalPuntos').text());

            const evaluacionData = {
                idParticipante: participanteSeleccionado.id,
                puntajes: puntajes,
                total: total
            };
            
            $('.btn-guardar').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');
            
            $.ajax({
                url: '/jurado/guardar',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(evaluacionData),
                success: function(response) {
                    
                    if (response.success) {
                        participanteSeleccionado.evaluado = true;
                        participanteSeleccionado.puntajes = puntajes;
                        
                        cerrarModal();
                        renderizarParticipantes();
                        actualizarProgreso();
                    } else {
                        alert('‚ùå Error: ' + (response.message || 'Error desconocido'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error al guardar:', xhr.responseText);
                    alert('‚ùå Error al guardar la evaluaci√≥n. Por favor, intenta nuevamente.');
                    $('.btn-guardar').prop('disabled', false).html('<i class="fas fa-save"></i> Guardar');
                }
            });
        }

        function actualizarProgreso() {
            if (!datosCompletos || !datosCompletos.participantes) return;
            
            const total = datosCompletos.participantes.length;
            const evaluados = datosCompletos.participantes.filter(p => p.evaluado).length;
            const porcentaje = total > 0 ? Math.round((evaluados / total) * 100) : 0;
            
            $('#textoProgreso').text(evaluados + ' de ' + total + ' evaluados');
            $('#barraProgreso').css('width', porcentaje + '%').text(porcentaje + '%');
            
            const estadoBadge = $('#estadoGeneral');
            if (porcentaje === 100) {
                estadoBadge
                    .removeClass('bg-secondary bg-warning')
                    .addClass('bg-success')
                    .html('<i class="fas fa-check-circle"></i> Completado');
            } else if (porcentaje > 0) {
                estadoBadge
                    .removeClass('bg-secondary bg-success')
                    .addClass('bg-warning')
                    .html('<i class="fas fa-hourglass-half"></i> ' + porcentaje + '% completado');
            }
        }

        function verificarCompletitud() {
            if (!datosCompletos || !datosCompletos.participantes) return;
            const total = datosCompletos.participantes.length;
            const evaluados = datosCompletos.participantes.filter(p => p.evaluado).length;
            if (evaluados === total) {
                $('#mensajeCompleto').slideDown();
                $.ajax({
                    url: '/jurado/notificar-completado',
                    method: 'POST',
                    success: function(response) {
                        console.log('‚úÖ Notificaci√≥n enviada:', response);
                    }
                });
            }
        }

        function segundosToDisplay(t) {
            const m = Math.floor(t / 60);
            const s = t % 60;
            return `${m}:${s.toString().padStart(2,'0')}`;
        }

        function sincronizarCronometroModal(data) {
            // Si el modal NO est√° visible, no hacemos nada (lo mostramos al abrir si corresponde)
            if (!$('#modalEvaluacion').hasClass('show')) return;

            // Determinar si el participante del modal coincide con el participante en presentaci√≥n
            const modalParticipantName = $('#nombreParticipanteModal').text();
            const modalMatches = participanteEnPresentacion && 
                                (participanteEnPresentacion.id === data.participanteId ||
                                participanteEnPresentacion.nombre === modalParticipantName);

            if (!modalMatches) {
                // Si el modal no corresponde al participante en presentaci√≥n, ocultamos el cron√≥metro en modal
                ocultarCronometroEnModal();
                return;
            }

            // Mostrar y sincronizar
            const nombre = data.participanteNombre || (participanteEnPresentacion && participanteEnPresentacion.nombre) || '-';
            $('#modalCronometroParticipante').html(`<i class="fas fa-user"></i> ${nombre}`);

            if (typeof data.tiempoRestante !== 'undefined' && data.tiempoRestante !== null) {
                $('#modalCronometroTiempo').text(segundosToDisplay(data.tiempoRestante));
            } else {
                // fallback: tomar del cronometro flotante
                $('#modalCronometroTiempo').text($('#cronometroTiempo').text());
            }

            // copiar clases/estado del cronometro flotante
            const clase = $('#cronometroTiempo').hasClass('amarillo') ? 'amarillo' :
                        $('#cronometroTiempo').hasClass('rojo') ? 'rojo' : 'verde';
            $('#modalCronometroTiempo').removeClass('verde amarillo rojo').addClass(clase);
            $('#modalCronometroEstado').html($('#cronometroEstado').html());

            $('#modalCronometro').show();
        }

        
        function mostrarCronometroEnModal(participante) {
            // llamada p√∫blica: abrir modal y mostrar cronometro basado en participanteEnPresentacion
            if (!participante) participante = participanteEnPresentacion;
            if (!participante) return;

            $('#modalCronometroParticipante').html(`<i class="fas fa-user"></i> ${participante.nombre || '-'}`);
            // sincronizar display del cronometro principal
            $('#modalCronometroTiempo').text($('#cronometroTiempo').text());
            const clase = $('#cronometroTiempo').hasClass('amarillo') ? 'amarillo' :
                        $('#cronometroTiempo').hasClass('rojo') ? 'rojo' : 'verde';
            $('#modalCronometroTiempo').removeClass('verde amarillo rojo').addClass(clase);
            $('#modalCronometroEstado').html($('#cronometroEstado').html());
            $('#modalCronometro').show();
        }

        function ocultarCronometroEnModal() {
            $('#modalCronometro').hide();
        }

        $(document).on('click', '.modal-evaluacion', function(e) {
            if (e.target === this) {
                cerrarModal();
            }
        });

        window.addEventListener('beforeunload', function(e) {
            if (!datosCompletos || !datosCompletos.participantes) return;
            const hayPendientes = datosCompletos.participantes.some(p => !p.evaluado);
            if (hayPendientes) {
                e.preventDefault();
                e.returnValue = 'Tienes evaluaciones pendientes. ¬øEst√°s seguro de salir?';
            }
        });
    </script>
</body>
</html>