<!DOCTYPE html>
<html lang="en">

<head th:replace="~{layout/head :: head}"></head>

<body class="fixed-left">
    <div id="preloader">
        <div id="status">
            <div class="spinner"></div>
        </div>
    </div>
    <div id="wrapper">
        <div th:replace="~{layout/sidebar :: sidebar}"></div>
        <div class="content-page">
            <div class="content">
                <div th:replace="~{layout/topbar :: topbar}"></div>
                <div class="container-xxl flex-grow-1 container-p-y" id="contenido">
                    <div id="concurso-dashboard" class="py-2">
                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <h5 class="mb-0">Progreso del Concurso</h5>

                                <select id="sel-actividad" class="form-select form-select-sm" style="min-width:260px">
                                    <option value="">Seleccione una actividad…</option>
                                </select>

                                <!-- <<< agrega esto -->
                                <span class="small text-muted">Actividad: <strong id="act-nombre">—</strong></span>
                                <!-- >>> -->
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="badge text-bg-light">Actualiza: <span id="last-update">—</span></span>
                                <button id="btn-refrescar" class="btn btn-sm btn-outline-primary"
                                    disabled>Refrescar</button>
                            </div>
                        </div>

                        <div id="sin-actividad" class="alert alert-secondary py-2" role="alert" style="display:none;">
                            Seleccione una actividad para ver el progreso.
                        </div>


                        <!-- Chips categorías -->
                        <div class="mb-3" id="categorias-wrap" style="display:none;">
                            <div id="categorias-chips" class="d-inline-flex overflow-auto"
                                style="white-space:nowrap;gap:.5rem;max-width:100%"></div>
                        </div>

                        <!-- Barra de progreso global -->
                        <div class="mb-3" id="resumen-wrap" style="display:none;">
                            <div class="d-flex justify-content-between small">
                                <div>Total evaluaciones</div>
                                <div><span id="rg-completadas">0</span> /
                                    <span id="rg-total">0</span>
                                    (<span id="rg-porcentaje">0.0</span>%)
                                </div>
                            </div>
                            <div class="progress">
                                <div id="rg-bar" class="progress-bar" role="progressbar" style="width:0%"></div>
                            </div>
                        </div>

                        <!-- Tabla por categoría -->
                        <div class="card">
                            <div class="card-body p-2 p-sm-3">
                                <div class="table-responsive">
                                    <table class="table table-sm align-middle" id="tabla">
                                        <thead>
                                            <tr id="thead-row">
                                                <th class="text-center" style="width:80px;min-width:80px">Puesto</th>
                                                <th style="min-width:220px">Participante</th>
                                                <!-- columnas de jurados se insertan aquí -->
                                                <th class="text-end" style="min-width:120px">Promedio</th>
                                                <th class="text-center">Estado</th>
                                                <th class="text-center" style="min-width:110px">Reporte</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody-rows">
                                            <tr id="fila-empty" style="display:none;">
                                                <td colspan="999" class="text-center text-muted py-4">
                                                    No hay registros para esta categoría.
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Paginación si la necesitas después -->
                            </div>
                        </div>
                    </div>

                    <!-- Template para chip de categoría -->
                    <template id="tpl-chip">
                        <button class="btn btn-sm">
                            <span class="chip-nombre"></span>
                            <span class="badge bg-white text-primary ms-1 chip-progreso"></span>
                        </button>
                    </template>

                    <!-- Template para una fila -->
                    <template id="tpl-row">
                        <tr>
                            <td class="text-center">
      <span class="row-medalla me-1"></span>
      <span class="row-puesto small text-muted"></span>
    </td>
                            <td>
                                <div class="fw-semibold row-participante"></div>
                                <div class="small text-muted row-institucion"></div>
                            </td>
                            <!-- celdas por jurado se agregan dinámicamente -->
                            <td class="text-end"><span class="fw-bold row-promedio"></span></td>
                            <td class="text-center"><span class="badge row-estado"></span></td>
                        </tr>
                    </template>

                </div>
            </div>
            <footer th:replace="~{layout/footer :: footer}"></footer>
        </div>
    </div>
    <div th:replace="~{layout/script :: script}"></div>
    <script>
        (function () {
            const root = document.getElementById('concurso-dashboard');
            if (!root) return;

            // Estado
            let actividadId = null;
            let categoriaId = null;
            let jurados = [];
            let filasFull = [];
            let sse = null, polling = null;

            // DOM
            const selAct = document.getElementById('sel-actividad');
            const sinActividad = document.getElementById('sin-actividad');
            const elActNombre = document.getElementById('act-nombre');
            const elLastUpdate = document.getElementById('last-update');
            const elBtnRefrescar = document.getElementById('btn-refrescar');

            const wrapCategorias = document.getElementById('categorias-wrap');
            const contChips = document.getElementById('categorias-chips');

            const wrapResumen = document.getElementById('resumen-wrap');
            const elRgComp = document.getElementById('rg-completadas');
            const elRgTotal = document.getElementById('rg-total');
            const elRgPct = document.getElementById('rg-porcentaje');
            const elRgBar = document.getElementById('rg-bar');

            const theadRow = document.getElementById('thead-row');
            const tbodyRows = document.getElementById('tbody-rows');
            const filaEmpty = document.getElementById('fila-empty');

            const tplChip = document.getElementById('tpl-chip');
            const tplRow = document.getElementById('tpl-row');

            // Init: primero cargamos actividades
            cargarActividades();

            // Eventos
            selAct.addEventListener('change', onActividadChange);
            elBtnRefrescar.addEventListener('click', () => cargarSnapshot(false));
            window.addEventListener('beforeunload', () => { if (polling) clearInterval(polling); if (sse) sse.close(); });

            async function cargarActividades() {
                try {
                    const r = await fetch('/api/admin/actividades');
                    if (r.status === 401) { window.location.href = '/LoginR'; return; }
                    const list = await r.json();

                    // Poblar select
                    selAct.innerHTML = '<option value="">Seleccione una actividad…</option>';
                    for (const a of list) {
                        const opt = document.createElement('option');
                        opt.value = a.id;
                        const fecha = a.fecha ? new Date(a.fecha).toLocaleDateString() : '';
                        opt.textContent = `${a.nombre}${fecha ? ' — ' + fecha : ''}`;
                        selAct.appendChild(opt);
                    }

                    // Autoselección: última usada (localStorage) o la primera
                    const last = localStorage.getItem('dash.actId');
                    if (last && list.some(a => String(a.id) === last)) {
                        selAct.value = last;
                    } else if (list.length === 1) {
                        selAct.value = list[0].id;
                    }

                    if (selAct.value) {
                        onActividadChange(); // dispara carga/sse
                    } else {
                        sinActividad.style.display = '';
                        elBtnRefrescar.disabled = true;
                    }

                } catch (e) { console.error(e); }
            }

            function onActividadChange() {
                actividadId = selAct.value ? Number(selAct.value) : null;
                localStorage.setItem('dash.actId', actividadId ? String(actividadId) : '');
                categoriaId = null; // reset filtro
                if (!actividadId) {
                    sinActividad.style.display = '';
                    elBtnRefrescar.disabled = true;
                    stopLive();
                    clearDashboard();
                    return;
                }
                sinActividad.style.display = 'none';
                elBtnRefrescar.disabled = false;
                stopLive();
                cargarSnapshot(false);
                startLive(); // SSE + polling
            }

            async function cargarSnapshot(silencioso) {
                if (!actividadId) return;
                try {
                    const url = `/api/admin/concurso/${actividadId}/snapshot` + (categoriaId ? `?categoriaId=${categoriaId}` : '');
                    const r = await fetch(url);
                    if (r.status === 401) { window.location.href = '/LoginR'; return; }
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    const data = await r.json();
                    renderSnapshot(data);
                    if (!silencioso) marcarActualizado();
                } catch (e) { console.error(e); }
            }

            function renderSnapshot(data) {
                if (elActNombre) elActNombre.textContent = data.actividad?.nombre ?? '—';

                const jNew = JSON.stringify(data.jurados || []);
                const jOld = JSON.stringify(jurados);
                const juradosChanged = (jNew !== jOld);
                jurados = data.jurados || [];
                if (juradosChanged) renderThead();

                renderCategorias(data.categorias || []);
                renderResumen(data.resumenGlobal || null);

                filasFull = data.filas || [];
                renderTbody();
            }

            function renderThead() {
                while (theadRow.children.length > 5) { // ahora hay columna "Reporte" extra
                    theadRow.removeChild(theadRow.children[2]);
                }
                const anchor = theadRow.children[theadRow.children.length - 3]; // antes de Promedio
                jurados.forEach(j => {
                    const th = document.createElement('th');
                    th.className = 'text-center';
                    th.innerHTML = `<div class="small text-muted">Jurado</div><div class="fw-semibold">${j.nombre}</div>`;
                    theadRow.insertBefore(th, anchor);
                });
            }

            function renderCategorias(categorias) {
                contChips.innerHTML = '';
                if (!categorias.length) { wrapCategorias.style.display = 'none'; return; }
                wrapCategorias.style.display = '';
                categorias.forEach(c => {
                    const chip = tplChip.content.firstElementChild.cloneNode(true);
                    chip.className = 'btn btn-sm ' + (categoriaId === c.id ? 'btn-primary' : 'btn-outline-primary');
                    chip.querySelector('.chip-nombre').textContent = c.nombre;
                    const prog = c.progreso || { total: 0, completadas: 0 };
                    chip.querySelector('.chip-progreso').textContent = `${prog.completadas}/${prog.total}`;
                    chip.addEventListener('click', () => { categoriaId = c.id; cargarSnapshot(true); renderCategorias(categorias); });
                    contChips.appendChild(chip);
                });
            }

            function renderResumen(rg) {
                if (!rg) { wrapResumen.style.display = 'none'; return; }
                wrapResumen.style.display = '';
                elRgComp.textContent = rg.completadas ?? 0;
                elRgTotal.textContent = rg.total ?? 0;
                elRgPct.textContent = (rg.porcentaje ?? 0).toFixed(1);
                elRgBar.style.width = `${rg.porcentaje ?? 0}%`;
            }

            function renderTbody() {
  // Limpia filas actuales (menos la vacía)
  tbodyRows.querySelectorAll('tr:not(#fila-empty)').forEach(tr => tr.remove());

  // Filtra por categoría (si aplica)
  const base = categoriaId ? filasFull.filter(f => f.categoriaId === categoriaId) : filasFull;

  if (!base.length) { 
    filaEmpty.style.display = '';
    return; 
  }
  filaEmpty.style.display = 'none';

  // Ordena por puntos desc (luego por promedio desc si quieres un desempate estable)
  const ordenado = base.slice().sort((a, b) => {
    const diff = getPuntos(b) - getPuntos(a);
    if (diff !== 0) return diff;
    const pa = typeof a.promedio === 'number' ? a.promedio : 0;
    const pb = typeof b.promedio === 'number' ? b.promedio : 0;
    return pb - pa;
  });

  // Asigna ranking con empates (1,1,3)
  let lastPts = null, lastRank = 0, i = 0;
  const ranked = ordenado.map(f => {
    i += 1;
    const pts = getPuntos(f);
    const rank = (pts === lastPts) ? lastRank : i;
    lastPts = pts;
    lastRank = rank;
    return { ...f, __rank: rank, __pts: pts };
  });

  const frag = document.createDocumentFragment();

  ranked.forEach(f => {
    const tr = tplRow.content.firstElementChild.cloneNode(true);

    // Puesto / Medalla
    const medallaEl = tr.querySelector('.row-medalla');
    const puestoEl  = tr.querySelector('.row-puesto');
    puestoEl.textContent = `#${f.__rank}`;
    medallaEl.textContent = (f.__rank === 1) ? '🥇' : (f.__rank === 2) ? '🥈' : (f.__rank === 3) ? '🥉' : '';

    // Participante / Institución
    tr.querySelector('.row-participante').textContent = f.participante ?? '—';
    tr.querySelector('.row-institucion').textContent = f.institucion ?? '—';

    // Quita las celdas "Promedio" y "Estado" del template para reinsertarlas luego,
    // pero búscalas por clase (no por índice).
    const promCell   = tr.querySelector('.row-promedio')?.closest('td');
    const estadoCell = tr.querySelector('.row-estado')?.closest('td');
    if (promCell)   promCell.remove();
    if (estadoCell) estadoCell.remove();

    // Inserta columnas de cada jurado (en el orden del thead)
    jurados.forEach(j => {
      const td = document.createElement('td');
      td.className = 'text-center';
      const val = f.scores && f.scores[j.id] !== undefined ? Number(f.scores[j.id]).toFixed(2) : '—';
      td.innerHTML = (val === '—') ? '<span class="text-muted">—</span>' : `<span class="fw-semibold">${val}</span>`;
      tr.appendChild(td);
    });

    // Promedio (o puntos) mostrado
    const tdProm = document.createElement('td');
    tdProm.className = 'text-end';
    // Muestra el total de puntos si existe; caso contrario, el promedio
    const toShow = (typeof f.puntos === 'number') ? f.puntos : (typeof f.promedio === 'number' ? f.promedio : 0);
    const fmt = Number.isInteger(toShow) ? toShow : toShow.toFixed(2);
    tdProm.innerHTML = `<span class="fw-bold">${fmt}</span>`;
    tr.appendChild(tdProm);

    // Estado
    const tdEstado = document.createElement('td');
    tdEstado.className = 'text-center';
    tdEstado.innerHTML = `<span class="badge ${f.completado ? 'text-bg-success' : 'text-bg-secondary'}">
      ${f.completado ? 'Completo' : 'Pendiente'}
    </span>`;
    tr.appendChild(tdEstado);

    // Reporte PDF
    const tdPdf = document.createElement('td');
    tdPdf.className = 'text-center';
    tdPdf.innerHTML = `
      <a class="btn btn-sm btn-outline-secondary"
         href="/api/admin/concurso/${actividadId}/reporte/inscripcion/${f.inscripcionId}.pdf"
         target="_blank" rel="noopener">
         <i class="bi bi-file-earmark-pdf"></i> PDF
      </a>`;
    tr.appendChild(tdPdf);

    frag.appendChild(tr);
  });

  tbodyRows.appendChild(frag);
}


            function marcarActualizado() {
                elLastUpdate.textContent = new Date().toLocaleTimeString();
            }

            function startLive() {
                stopLive();
                if (!actividadId) return;
                try {
                    sse = new EventSource(`/api/admin/concurso/${actividadId}/stream`);
                    sse.onmessage = (ev) => {
                        try {
                            const p = JSON.parse(ev.data);
                            if (p.filas) { filasFull = p.filas; renderTbody(); }
                            if (p.categorias) { renderCategorias(p.categorias); }
                            if (p.resumenGlobal) { renderResumen(p.resumenGlobal); }
                            marcarActualizado();
                        } catch (e) { console.error(e); }
                    };
                    sse.onerror = () => { /* silencioso */ };
                } catch (e) { console.warn('SSE no disponible'); }
                polling = setInterval(() => cargarSnapshot(true), 15000);
            }

            function stopLive() {
                if (sse) { try { sse.close(); } catch (e) { } sse = null; }
                if (polling) { clearInterval(polling); polling = null; }
            }

            function clearDashboard() {
                elActNombre.textContent = '—';
                contChips.innerHTML = ''; wrapCategorias.style.display = 'none';
                renderResumen(null);
                jurados = []; renderThead();
                filasFull = []; tbodyRows.querySelectorAll('tr:not(#fila-empty)').forEach(tr => tr.remove());
                filaEmpty.style.display = '';
                elLastUpdate.textContent = '—';
            }
        })();

        function getPuntos(f) {
            if (typeof f.puntos === 'number') return f.puntos;
            if (typeof f.promedio === 'number') return f.promedio;
            return 0;
            }

    </script>

</body>

</html>