<div th:fragment="script">
    <!-- jQuery  -->
    <script src="../../../../assets/js/jquery.min.js"></script>
    <script src="../../../../assets/js/bootstrap.bundle.min.js"></script>
    <script src="../../../../assets/js/modernizr.min.js"></script>
    <script src="../../../../assets/js/detect.js"></script>
    <script src="../../../../assets/js/fastclick.js"></script>
    <script src="../../../../assets/js/jquery.slimscroll.js"></script>
    <script src="../../../../assets/js/jquery.blockUI.js"></script>
    <script src="../../../../assets/js/waves.js"></script>
    <script src="../../../../assets/js/jquery.nicescroll.js"></script>
    <script src="../../../../assets/js/jquery.scrollTo.min.js"></script>

    <!-- skycons -->
    <script src="../../../../assets/plugins/skycons/skycons.min.js"></script>

    <!-- skycons -->
    <script src="../../../../assets/plugins/peity/jquery.peity.min.js"></script>

    <!--Morris Chart-->
    <!-- <script src="../../../../assets/plugins/morris/morris.min.js"></script> -->
    <!-- <script src="../../../../assets/plugins/raphael/raphael-min.js"></script> -->

    <!-- dashboard -->
    <!-- <script src="../../../../assets/pages/dashboard.js"></script> -->

    <!-- Required datatable js -->
    <script src="../../../../assets/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="../../../../assets/plugins/datatables/dataTables.bootstrap4.min.js"></script>
    <!-- Buttons examples -->
    <script src="../../../../assets/plugins/datatables/dataTables.buttons.min.js"></script>
    <script src="../../../../assets/plugins/datatables/buttons.bootstrap4.min.js"></script>
    <script src="../../../../assets/plugins/datatables/jszip.min.js"></script>
    <script src="../../../../assets/plugins/datatables/pdfmake.min.js"></script>
    <script src="../../../../assets/plugins/datatables/vfs_fonts.js"></script>
    <script src="../../../../assets/plugins/datatables/buttons.html5.min.js"></script>
    <script src="../../../../assets/plugins/datatables/buttons.print.min.js"></script>
    <script src="../../../../assets/plugins/datatables/buttons.colVis.min.js"></script>
    <!-- Responsive examples -->
    <script src="../../../../assets/plugins/datatables/dataTables.responsive.min.js"></script>
    <script src="../../../../assets/plugins/datatables/responsive.bootstrap4.min.js"></script>

    <!-- Datatable init js -->
    <script src="../../../../assets/pages/datatables.init.js"></script>

    <!-- Plugins js -->
    <script src="../../../../assets/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js"></script>
    <script src="../../../../assets/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>
    <script src="../../../../assets/plugins/bootstrap-maxlength/bootstrap-maxlength.min.js"></script>
    <script src="../../../../assets/plugins/bootstrap-touchspin/js/jquery.bootstrap-touchspin.min.js"></script>
    <!-- App js -->
    <script src="../../../../assets/js/app.js"></script>
    <script src="../../../../assets/js/fragment.js"></script>

    <!-- INICIO TODOS ESTOS ARCHIVOS SON PARA SELECT BUSCADOR-->
    <script src="../../../../vendors/choices/choices.min.js"></script>
    <script src="../../../../vendors/anchorjs/anchor.min.js"></script><!--esto-->
    <script src="../../../../vendors/lodash/lodash.min.js"></script><!--esto-->
    <!-- <script src="../../../../assets/js/theme.js"></script> -->
    <!-- FIN TODOS ESTOS ARCHIVOS SON PARA SELECT BUSCADOR-->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- SWEET-ALERT JS -->
    <script src="../../../../assets/plugins/sweet-alert2/sweetalert2.min.js"></script>
    <!-- JS de Tagify -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.6.0/dist/tagify.min.js"></script>

    <script>

        if (typeof showGlobalLoader !== 'function') {
            window.showGlobalLoader = function () { /* no-op */ };
        }
        if (typeof hideGlobalLoader !== 'function') {
            window.hideGlobalLoader = function () { /* no-op */ };
        }
        if (typeof cargarFormularioAlert !== 'function') {
            window.cargarFormularioAlert = function (url, contenedorModal, selectorForm) {
                $.post(url).done(html => {
                    $(contenedorModal).html(html);
                    $('#modalFormularioPersona').modal('show');
                }).fail(() => Swal.fire('Error', 'No se pudo cargar el formulario.', 'error'));
            };
        }
        if (typeof cargarFormularioEditAlert !== 'function') {
            window.cargarFormularioEditAlert = function (idEnc, baseUrl, contenedorModal, selectorForm) {
                $.post(`${baseUrl}/${idEnc}`).done(html => {
                    $(contenedorModal).html(html);
                    $('#modalFormularioPersona').modal('show');
                }).fail(() => Swal.fire('Error', 'No se pudo cargar el formulario de edición.', 'error'));
            };
        }
        if (typeof eliminarRegistroAlert !== 'function') {
            window.eliminarRegistroAlert = function (nombre, idEnc, baseUrl, onOk) {
                Swal.fire({
                    title: 'Eliminar registro',
                    text: `¿Deseas eliminar ${nombre}?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Eliminar',
                    cancelButtonText: 'Cancelar'
                }).then(res => {
                    if (!res.isConfirmed) return;
                    $.post(`${baseUrl}/${idEnc}`)
                        .done(() => { if (typeof onOk === 'function') onOk(); })
                        .fail(() => Swal.fire('Error', 'No se pudo eliminar.', 'error'));
                });
            };
        }

        // ============================================
        // SCRIPT DE NAVEGACIÓN DEL SIDEBAR - CORREGIDO
        // ============================================

        (function () {
            'use strict';
            
            // Esperar a que el DOM y jQuery estén listos
            if (typeof jQuery === 'undefined') {
                console.error('jQuery no está cargado');
                return;
            }

            // Variables globales
            let $contenido = null;
            let $currentActive = null;

            // Configuración
            const CONFIG = {
                USE_PREFETCH: false,
                PREFETCH_URL: "/adm/cargar-datos",
                CONTENIDO_SELECTOR: "#contenido", // Asegúrate que este ID existe en tu HTML
                DEBUG: true // Cambia a false en producción
            };

            // Función de log para debug
            function log(...args) {
                if (CONFIG.DEBUG) {
                    console.log('[SIDEBAR NAV]', ...args);
                }
            }

            // ===== INICIALIZACIÓN =====
            function init() {
                log('Inicializando navegación del sidebar...');
                
                // Buscar el contenedor de contenido
                $contenido = $(CONFIG.CONTENIDO_SELECTOR);
                
                if (!$contenido.length) {
                    console.error(`No se encontró el contenedor ${CONFIG.CONTENIDO_SELECTOR}`);
                    return;
                }

                log('Contenedor encontrado:', $contenido);

                // Configurar event listeners
                setupEventListeners();

                // Cargar vista por defecto
                cargarVistaPorDefecto();

                log('Navegación inicializada correctamente');
            }

            // ===== CONFIGURAR EVENT LISTENERS =====
            function setupEventListeners() {
                // IMPORTANTE: Usar delegación de eventos para elementos dinámicos
                $(document).off('click', 'a.menu-ajax'); // Limpiar listeners previos
                $(document).on('click', 'a.menu-ajax', function (e) {
                    e.preventDefault();
                    e.stopPropagation(); // Prevenir propagación
                    
                    const $link = $(this);
                    log('Click en enlace:', $link.data('url'));
                    
                    handleMenuClick($link);
                });

                // Soporte para navegación del navegador (atrás/adelante)
                window.addEventListener('popstate', handlePopState);

                log('Event listeners configurados');
            }

            // ===== MANEJAR CLICK EN MENÚ =====
            function handleMenuClick($link) {
                const url = $link.data('url');
                
                if (!url) {
                    log('Enlace sin URL configurada');
                    return;
                }

                log('Cargando URL:', url);

                // Marcar como activo
                setActive($link);

                // Cargar contenido
                cargarContenido(url, true);

                // Cerrar menú móvil si está abierto
                cerrarMenuMovil();
            }

            // ===== CARGAR CONTENIDO =====
            function cargarContenido(url, pushHistory = true) {
                if (!$contenido || !$contenido.length) {
                    console.error('No hay contenedor de contenido disponible');
                    return;
                }

                log('Cargando contenido desde:', url);

                // Mostrar spinner de carga
                mostrarSpinner();

                const doLoad = () => {
                    $.ajax({
                        url: url,
                        method: "GET",
                        dataType: "html",
                        timeout: 30000, // 30 segundos timeout
                        success: function (html) {
                            log('Contenido cargado exitosamente');
                            $contenido.html(html);
                            
                            // Actualizar URL del navegador
                            if (pushHistory) {
                                actualizarHistorial(url);
                            }

                            // Ejecutar scripts que puedan venir en el HTML
                            ejecutarScriptsEnContenido();
                        },
                        error: function (xhr, status, error) {
                            log('Error al cargar contenido:', status, error);
                            manejarErrorCarga(xhr);
                        }
                    });
                };

                // Pre-fetch opcional
                if (CONFIG.USE_PREFETCH) {
                    $.get(CONFIG.PREFETCH_URL).always(doLoad);
                } else {
                    doLoad();
                }
            }

            // ===== MOSTRAR SPINNER DE CARGA =====
            function mostrarSpinner() {
                $contenido.html(`
                    <div class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-3 text-muted">Cargando contenido...</p>
                        </div>
                    </div>
                `);
            }

            // ===== MANEJAR ERRORES =====
            function manejarErrorCarga(xhr) {
                if (xhr.status === 401) {
                    // Sesión expirada
                    Swal.fire({
                        title: 'Sesión expirada',
                        text: 'Tu sesión ha expirado. Por favor, inicia sesión nuevamente.',
                        icon: 'warning',
                        confirmButtonText: 'Ir al login',
                        allowOutsideClick: false
                    }).then(() => {
                        window.location.href = '/LoginR';
                    });
                    return;
                }

                if (xhr.status === 404) {
                    $contenido.html(`
                        <div class="alert alert-warning m-4">
                            <h4><i class="bi bi-exclamation-triangle"></i> Página no encontrada</h4>
                            <p>La vista solicitada no existe.</p>
                        </div>
                    `);
                    return;
                }

                // Error genérico
                console.error('Error al cargar la vista:', xhr);
                $contenido.html(`
                    <div class="alert alert-danger m-4">
                        <h4><i class="bi bi-x-circle"></i> Error al cargar</h4>
                        <p>No se pudo cargar el contenido. Por favor, intenta nuevamente.</p>
                        <button class="btn btn-primary btn-sm" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> Recargar página
                        </button>
                    </div>
                `);
            }

            // ===== MARCAR ENLACE ACTIVO =====
            function setActive($link) {
                // Remover clase activa del anterior
                if ($currentActive) {
                    $currentActive.removeClass('active');
                    $currentActive.parents('li.has_sub').removeClass('active opened');
                }

                // Activar el nuevo enlace
                $currentActive = $link.closest('li');
                $currentActive.addClass('active');

                // Abrir submenús padres si existen
                $currentActive.parents('li.has_sub').addClass('active opened');

                log('Enlace marcado como activo:', $link.data('url'));
            }

            // ===== ACTUALIZAR HISTORIAL DEL NAVEGADOR =====
            function actualizarHistorial(url) {
                const $link = $(`a.menu-ajax[data-url="${url}"]`);
                const hrefToPush = $link.data('href') || url;
                
                if (window.history && window.history.pushState) {
                    window.history.pushState({ url: url }, "", hrefToPush);
                    log('Historial actualizado:', hrefToPush);
                }
            }

            // ===== MANEJAR NAVEGACIÓN ATRÁS/ADELANTE =====
            function handlePopState(ev) {
                const state = ev.state || {};
                if (state.url) {
                    log('Navegación del historial:', state.url);
                    cargarContenido(state.url, false);
                }
            }

            // ===== CERRAR MENÚ MÓVIL =====
            function cerrarMenuMovil() {
                const $menuBtn = $('.button-menu-mobile.open-left');
                if ($menuBtn.length && $('body').hasClass('enlarged')) {
                    $menuBtn.trigger('click');
                    log('Menú móvil cerrado');
                }
            }

            // ===== CARGAR VISTA POR DEFECTO =====
            function cargarVistaPorDefecto() {
                // Solo cargar si estamos en contexto de administración
                if (document.body.dataset.ctx !== "A") {
                    log('No es contexto de administración, saltando carga por defecto');
                    return;
                }

                // Buscar enlace marcado como default
                const $default = $('a.menu-ajax[data-default="true"]').first();
                
                if ($default.length) {
                    log('Cargando vista por defecto:', $default.data('url'));
                    setActive($default);
                    cargarContenido($default.data('url'), true);
                } else {
                    log('No hay vista por defecto configurada');
                }
            }

            // ===== EJECUTAR SCRIPTS EN CONTENIDO CARGADO =====
            function ejecutarScriptsEnContenido() {
                // Buscar y ejecutar scripts que vengan en el contenido cargado
                $contenido.find('script').each(function() {
                    try {
                        if (this.src) {
                            // Script externo
                            const script = document.createElement('script');
                            script.src = this.src;
                            document.head.appendChild(script);
                        } else {
                            // Script inline
                            eval(this.textContent);
                        }
                    } catch (e) {
                        console.error('Error ejecutando script:', e);
                    }
                });
            }

            // ===== INICIALIZAR CUANDO EL DOM ESTÉ LISTO =====
            $(document).ready(function() {
                log('DOM listo, iniciando...');
                init();
            });

            // Exposer funciones globales si son necesarias
            window.sidebar_navigation = {
                cargarContenido: cargarContenido,
                setActive: setActive
            };

        })();

        // ============================================
        // FUNCIONES GLOBALES DE UTILIDAD
        // ============================================

        if (typeof showGlobalLoader !== 'function') {
            window.showGlobalLoader = function () {
                console.log('showGlobalLoader llamado');
            };
        }

        if (typeof hideGlobalLoader !== 'function') {
            window.hideGlobalLoader = function () {
                console.log('hideGlobalLoader llamado');
            };
        }

        if (typeof cargarFormularioAlert !== 'function') {
            window.cargarFormularioAlert = function (url, contenedorModal, selectorForm) {
                $.post(url)
                    .done(html => {
                        $(contenedorModal).html(html);
                        $('#modalFormularioPersona').modal('show');
                    })
                    .fail(() => {
                        Swal.fire('Error', 'No se pudo cargar el formulario.', 'error');
                    });
            };
        }

        if (typeof cargarFormularioEditAlert !== 'function') {
            window.cargarFormularioEditAlert = function (idEnc, baseUrl, contenedorModal, selectorForm) {
                $.post(`${baseUrl}/${idEnc}`)
                    .done(html => {
                        $(contenedorModal).html(html);
                        $('#modalFormularioPersona').modal('show');
                    })
                    .fail(() => {
                        Swal.fire('Error', 'No se pudo cargar el formulario de edición.', 'error');
                    });
            };
        }

        if (typeof eliminarRegistroAlert !== 'function') {
            window.eliminarRegistroAlert = function (nombre, idEnc, baseUrl, onOk) {
                Swal.fire({
                    title: 'Eliminar registro',
                    text: `¿Deseas eliminar ${nombre}?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Eliminar',
                    cancelButtonText: 'Cancelar'
                }).then(res => {
                    if (!res.isConfirmed) return;
                    $.post(`${baseUrl}/${idEnc}`)
                        .done(() => {
                            if (typeof onOk === 'function') onOk();
                        })
                        .fail(() => {
                            Swal.fire('Error', 'No se pudo eliminar.', 'error');
                        });
                });
            };
        }
    </script>
</div>